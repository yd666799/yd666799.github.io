<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大明朱雀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        info: '#40A9FF',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-active {
                @apply bg-primary/10 text-primary border-primary/20;
            }
            .btn-inactive {
                @apply bg-white text-gray-600 border-gray-200;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 密码验证页面 -->
    <div id="password-page" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-primary/10">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">大明朱雀</h2>
                <p class="text-gray-500 mt-2">欢迎你</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">输入密钥</label>
                    <div class="relative">
                        <input type="text" id="password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="#2QQGGU888">
                        <button id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <p id="password-error" class="text-danger text-sm mt-1 hidden">撸晕了吗</p>
                </div>
                
                <button id="login-btn" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300">
                    撸
                </button>
            </div>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="app" class="hidden flex flex-col h-screen">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-bar-chart text-primary text-xl"></i>
                    <h1 class="text-lg font-bold text-gray-800">大明朱雀</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span id="current-month-display" class="text-sm text-gray-600"></span>
                        <button id="change-month-btn" class="text-primary hover:text-primary/80 text-sm flex items-center">
                            <i class="fa fa-calendar-o mr-1"></i> 切换月份
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
            <!-- 记录类型切换 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">记录类型：</span>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="root-records-btn" class="px-4 py-2 text-sm font-medium rounded-l-lg border transition-colors btn-active">
                                根记录
                            </button>
                            <button type="button" id="monthly-records-btn" class="px-4 py-2 text-sm font-medium rounded-r-lg border transition-colors btn-inactive">
                                月度记录
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <button id="add-record-btn" class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors shadow-sm">
                            <i class="fa fa-plus mr-2"></i> 添加记录
                        </button>
                        
                        <div class="relative inline-block" id="import-container">
                            <button id="import-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-upload mr-2"></i> 导入
                            </button>
                            <div id="import-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="import-single-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">单个导入</button>
                                <button id="import-batch-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">批量导入</button>
                            </div>
                        </div>
                        
                        <div class="relative inline-block" id="export-container">
                            <button id="export-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-download mr-2"></i> 导出
                            </button>
                            <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="export-selected-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出选中</button>
                                <button id="export-all-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出全部</button>
                            </div>
                        </div>
                        
                        <button id="inherit-btn" class="inline-flex items-center px-4 py-2 bg-success text-white text-sm font-medium rounded-lg hover:bg-success/90 transition-colors shadow-sm">
                            <i class="fa fa-clone mr-2"></i> 继承根记录
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 排序和筛选 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">排序方式：</span>
                            <select id="sort-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="prosperity">按繁荣值高低</option>
                                <option value="score">按得分值高低</option>
                                <option value="position">按职位优先级</option>
                                <option value="evaluation">按评测优先级</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">筛选：</span>
                            <select id="filter-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="all">全部</option>
                                <option value="in-clan">仅在部落</option>
                                <option value="out-clan">不在部落</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="select-all-btn" class="text-sm text-primary hover:text-primary/80">
                            <i class="fa fa-check-square-o mr-1"></i> 全选
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="deselect-all-btn" class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fa fa-square-o mr-1"></i> 取消选择
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="delete-selected-btn" class="text-sm text-danger hover:text-danger/80">
                            <i class="fa fa-trash-o mr-1"></i> 删除选中
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 数据表格 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 w-12">
                                    <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                                </th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">繁荣</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名字</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标签</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职位</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">历史最高奖杯</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">加入时间</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联赛总次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">实际次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总星数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">摧毁率</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">得分</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">评测</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">是否在部落</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                            <tr class="text-center">
                                <td colspan="15" class="px-4 py-8 text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                        <p>暂无记录，请添加或导入数据</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div id="pagination" class="px-4 py-3 flex items-center justify-between border-t border-gray-200 bg-white hidden">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prev-page-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            上一页
                        </button>
                        <button id="next-page-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            下一页
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                显示第 <span id="current-range" class="font-medium">1-10</span> 条，共 <span id="total-records" class="font-medium">0</span> 条记录
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">上一页</span>
                                    <i class="fa fa-chevron-left text-xs"></i>
                                </button>
                                <div id="page-numbers" class="flex">
                                    <!-- 页码将动态生成 -->
                                </div>
                                <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">下一页</span>
                                    <i class="fa fa-chevron-right text-xs"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据预览卡片 -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-primary">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">总记录数</h3>
                        <i class="fa fa-database text-primary"></i>
                    </div>
                    <p id="total-records-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-success">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">在部落成员</h3>
                        <i class="fa fa-users text-success"></i>
                    </div>
                    <p id="in-clan-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-warning">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">平均得分</h3>
                        <i class="fa fa-line-chart text-warning"></i>
                    </div>
                    <p id="average-score" class="mt-1 text-2xl font-semibold text-gray-900">0.0000</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 添加/编辑记录模态框 -->
    <div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" id="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900">添加记录</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="record-form" class="p-6 space-y-4">
                <input type="hidden" id="record-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="prosperity" class="block text-sm font-medium text-gray-700 mb-1">繁荣</label>
                        <input type="number" id="prosperity" step="any"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入繁荣值">
                    </div>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">名字</label>
                        <input type="text" id="name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入名字">
                    </div>
                    
                    <div>
                        <label for="tag" class="block text-sm font-medium text-gray-700 mb-1">标签 <span class="text-danger text-xs">(唯一)</span></label>
                        <input type="text" id="tag"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入标签">
                        <p id="tag-error" class="text-danger text-xs mt-1 hidden">该标签已存在，请修改或编辑已有记录</p>
                    </div>
                    
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700 mb-1">职位</label>
                        <select id="position" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择职位</option>
                            <option value="leader">首领</option>
                            <option value="coLeader">副首领</option>
                            <option value="elder">长老</option>
                            <option value="member">成员</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="maxTrophies" class="block text-sm font-medium text-gray-700 mb-1">历史最高奖杯数</label>
                        <input type="number" id="maxTrophies"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入历史最高奖杯数">
                    </div>
                    
                    <div>
                        <label for="joinDate" class="block text-sm font-medium text-gray-700 mb-1">加入起始时间</label>
                        <input type="date" id="joinDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                    </div>
                    
                    <div>
                        <label for="leagueTotal" class="block text-sm font-medium text-gray-700 mb-1">当月联赛总次数</label>
                        <input type="number" id="leagueTotal" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入联赛总次数">
                    </div>
                    
                    <div>
                        <label for="actualTimes" class="block text-sm font-medium text-gray-700 mb-1">实际次数</label>
                        <input type="number" id="actualTimes" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入实际次数">
                    </div>
                    
                    <div>
                        <label for="totalStars" class="block text-sm font-medium text-gray-700 mb-1">总星数</label>
                        <input type="number" id="totalStars" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入总星数">
                    </div>
                    
                    <div>
                        <label for="destructionRate" class="block text-sm font-medium text-gray-700 mb-1">摧毁率 (%)</label>
                        <input type="number" id="destructionRate" step="0.01" min="0" max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入摧毁率">
                    </div>
                    
                    <div>
                        <label for="score" class="block text-sm font-medium text-gray-700 mb-1">得分 (自动计算)</label>
                        <input type="text" id="score" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                               placeholder="自动计算">
                    </div>
                    
                    <div>
                        <label for="evaluation" class="block text-sm font-medium text-gray-700 mb-1">评测</label>
                        <select id="evaluation" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择评测</option>
                            <option value="powerhouse">实力派</option>
                            <option value="highQuality">优质</option>
                            <option value="backbone">中坚</option>
                            <option value="potential">潜力股</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">是否在部落</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="true" class="text-primary focus:ring-primary h-4 w-4" checked>
                            <span class="ml-2 text-sm text-gray-700">是</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="false" class="text-primary focus:ring-primary h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">否</span>
                        </label>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" id="cancel-form" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 下载格式选择模态框 -->
    <div id="download-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="download-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择下载格式</h3>
                    <button id="close-download-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="json" checked class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">JSON 格式 (.json)</span>
                    </label>
                    
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="csv" class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">CSV 格式 (.csv)</span>
                    </label>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-download" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认下载
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 月份选择模态框 -->
    <div id="month-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="month-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择月份</h3>
                    <button id="close-month-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label for="selected-month" class="block text-sm font-medium text-gray-700 mb-1">选择月份</label>
                    <input type="month" id="selected-month"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-month" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入文件输入框（隐藏） -->
    <input type="file" id="import-file" accept=".json,.csv" class="hidden">

    <!-- 提示消息组件 -->
    <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <i id="toast-icon" class="mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // 配置Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB40MBHZ3U6xPG_N1ulqVqeZGZnBCbSAWg",
            authDomain: "share-notes-1b48c.firebaseapp.com",
            projectId: "share-notes-1b48c",
            storageBucket: "share-notes-1b48c.appspot.com",
            messagingSenderId: "99459795397",
            appId: "1:99459795397:web:1a727e631c50f840fbe3a",
            measurementId: "G-09DG9T1FGB",
            databaseURL: "https://share-notes-1b48c-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // 初始化Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        
        // 暴露Firebase功能到全局
        window.firebase = {
            db,
            ref,
            set,
            get,
            onValue,
            push,
            remove,
            update,
            // 实时同步状态
            syncing: false,
            syncPath: null,
            syncListener: null
        };
    </script>

    <script>
        // 全局变量存储当前记录数据
        let currentRecords = [];
        let currentMonth = new Date().toISOString().slice(0, 7); // 格式: YYYY-MM
        let currentRecordType = 'root'; // 'root' 或 'monthly'
        let selectedRecords = new Set();
        let currentPage = 1;
        const recordsPerPage = 10;
        
        // 登录逻辑
        (function() {
            const passwordPage = document.getElementById('password-page');
            const app = document.getElementById('app');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const passwordError = document.getElementById('password-error');
            const togglePassword = document.getElementById('toggle-password');

            // 绑定登录按钮点击事件
            loginBtn.addEventListener('click', validatePassword);
            
            // 回车键登录
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    validatePassword();
                }
            });

            // 密码可见性切换
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
            });

            function validatePassword() {
                const input = passwordInput.value.trim();
                passwordError.classList.add('hidden');
                passwordInput.classList.remove('border-danger');
                
                if (!input) {
                    showError('别撸了害怕');
                    return;
                }
                
                try {
                    // 替换运算符并计算
                    const expr = input.replace(/a/g, '*').replace(/b/g, '/').replace(/c/g, '+').replace(/d/g, '-');
                    const result = eval(expr);
                    
                    if (Math.abs(result - 7) < 0.0001) {
                        passwordPage.classList.add('hidden');
                        app.classList.remove('hidden');
                        initMainApp();
                        showToast('出货', 'success');
                    } else {
                        showError(`并非${result.toFixed(2)}，你撸眼花了`);
                    }
                } catch (e) {
                    showError('换个姿势呢');
                }
            }

            function showError(message) {
                passwordError.textContent = message;
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-danger');
                setTimeout(() => passwordInput.classList.remove('border-danger'), 1000);
            }

            // 初始化主应用
            function initMainApp() {
                // 设置当前月份显示
                document.getElementById('current-month-display').textContent = formatMonth(currentMonth);
                
                // 启动时先从Firebase加载数据
                startFirebaseSync();
                
                // 绑定各种事件监听器
                bindEventListeners();
            }

            // 格式化月份显示
            function formatMonth(monthString) {
                const [year, month] = monthString.split('-');
                return `${year}年${parseInt(month)}月`;
            }

            // 开始Firebase同步
            function startFirebaseSync() {
                // 先从Firebase加载数据
                loadRecordsFromFirebase();
                
                // 设置实时监听器
                setupFirebaseListener();
            }

            // 从Firebase加载记录
            function loadRecordsFromFirebase() {
                try {
                    const path = getFirebasePath();
                    const { db, ref, get } = window.firebase;
                    const dataRef = ref(db, path);
                    
                    get(dataRef)
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                if (data && Array.isArray(data)) {
                                    currentRecords = data;
                                    // 同时保存到本地存储
                                    saveRecordsToLocalStorage();
                                    sortRecords();
                                    renderRecordsTable();
                                    updateSummaryCards();
                                    showToast('数据已从云端加载', 'success');
                                } else {
                                    // 如果云端没有数据，尝试从本地加载
                                    loadRecordsFromLocalStorage();
                                }
                            } else {
                                // 如果云端没有数据，尝试从本地加载
                                loadRecordsFromLocalStorage();
                            }
                        })
                        .catch((error) => {
                            console.error('从Firebase加载数据失败:', error);
                            showToast(`加载云端数据失败，将使用本地数据: ${error.message}`, 'warning');
                            // 尝试从本地加载
                            loadRecordsFromLocalStorage();
                        });
                } catch (e) {
                    console.error('加载数据失败:', e);
                    showToast('加载数据失败: ' + e.message, 'error');
                    // 尝试从本地加载
                    loadRecordsFromLocalStorage();
                }
            }

            // 设置Firebase实时监听器
            function setupFirebaseListener() {
                // 先移除之前的监听器
                if (window.firebase.syncListener) {
                    window.firebase.syncListener();
                }
                
                try {
                    const path = getFirebasePath();
                    const { db, ref, onValue } = window.firebase;
                    const dataRef = ref(db, path);
                    
                    // 设置新的监听器
                    const unsubscribe = onValue(dataRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data && Array.isArray(data)) {
                            // 只在数据有变化时更新
                            if (JSON.stringify(data) !== JSON.stringify(currentRecords)) {
                                currentRecords = data;
                                saveRecordsToLocalStorage(); // 同时更新本地存储
                                sortRecords();
                                renderRecordsTable();
                                updateSummaryCards();
                                showToast('数据已从云端更新', 'info');
                            }
                        }
                    });
                    
                    window.firebase.syncListener = unsubscribe;
                    window.firebase.syncPath = path;
                    window.firebase.syncing = true;
                } catch (error) {
                    console.error('设置Firebase监听失败:', error);
                    showToast(`设置云端同步失败: ${error.message}`, 'error');
                }
            }

            // 获取Firebase路径
            function getFirebasePath() {
                return currentRecordType === 'root'
                    ? 'root-records'
                    : `monthly-records-${currentMonth}`;
            }

            // 同步到Firebase
            function syncToFirebase() {
                if (!window.firebase.syncing || !window.firebase.syncPath) return;
                
                try {
                    const { db, ref, set } = window.firebase;
                    const dataRef = ref(db, window.firebase.syncPath);
                    
                    // 保存数据到Firebase
                    set(dataRef, currentRecords)
                        .then(() => {
                            console.log('数据已同步到云端');
                        })
                        .catch((error) => {
                            console.error('同步到云端失败:', error);
                            showToast(`同步到云端失败: ${error.message}`, 'error');
                        });
                } catch (error) {
                    console.error('云端同步操作失败:', error);
                }
            }

            // 从本地存储加载记录
            function loadRecordsFromLocalStorage() {
                try {
                    let storedRecords;
                    if (currentRecordType === 'root') {
                        // 根记录：永久存储，不关联月份
                        storedRecords = localStorage.getItem('root-records');
                    } else {
                        // 月度记录：按月份存储
                        storedRecords = localStorage.getItem(`monthly-records-${currentMonth}`);
                    }
                    
                    if (storedRecords) {
                        currentRecords = JSON.parse(storedRecords);
                        sortRecords();
                        renderRecordsTable();
                        updateSummaryCards();
                    } else {
                        currentRecords = [];
                        renderRecordsTable();
                        updateSummaryCards();
                    }
                } catch (e) {
                    console.error('加载本地存储失败:', e);
                    showToast('加载本地数据失败: ' + e.message, 'error');
                    currentRecords = [];
                }
            }

            // 保存记录到本地存储
            function saveRecordsToLocalStorage() {
                try {
                    if (currentRecordType === 'root') {
                        // 根记录：永久存储，不关联月份
                        localStorage.setItem('root-records', JSON.stringify(currentRecords));
                    } else {
                        // 月度记录：按月份存储
                        localStorage.setItem(`monthly-records-${currentMonth}`, JSON.stringify(currentRecords));
                    }
                    
                    // 自动同步到Firebase
                    syncToFirebase();
                } catch (e) {
                    console.error('保存到本地存储失败:', e);
                    showToast('保存本地数据失败: ' + e.message, 'error');
                }
            }

            // 绑定事件监听器
            function bindEventListeners() {
                // 记录类型切换按钮
                document.getElementById('root-records-btn').addEventListener('click', () => {
                    switchRecordType('root');
                });
                document.getElementById('monthly-records-btn').addEventListener('click', () => {
                    switchRecordType('monthly');
                });

                // 添加记录按钮
                document.getElementById('add-record-btn').addEventListener('click', openRecordModal);

                // 导入/导出下拉菜单
                document.getElementById('import-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const importDropdown = document.getElementById('import-dropdown');
                    importDropdown.classList.toggle('hidden');
                    document.getElementById('export-dropdown').classList.add('hidden');
                });
                
                document.getElementById('export-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const exportDropdown = document.getElementById('export-dropdown');
                    exportDropdown.classList.toggle('hidden');
                    document.getElementById('import-dropdown').classList.add('hidden');
                });

                // 点击其他地方关闭下拉菜单
                document.addEventListener('click', () => {
                    document.getElementById('import-dropdown').classList.add('hidden');
                    document.getElementById('export-dropdown').classList.add('hidden');
                });

                // 导入下拉菜单按钮
                document.getElementById('import-single-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('import-dropdown').classList.add('hidden');
                    const importFile = document.getElementById('import-file');
                    importFile.multiple = false;
                    importFile.click();
                });
                
                document.getElementById('import-batch-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('import-dropdown').classList.add('hidden');
                    const importFile = document.getElementById('import-file');
                    importFile.multiple = true;
                    importFile.click();
                });

                // 导出下拉菜单按钮
                document.getElementById('export-selected-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('export-dropdown').classList.add('hidden');
                    exportSelectedRecords();
                });
                
                document.getElementById('export-all-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('export-dropdown').classList.add('hidden');
                    exportAllRecords();
                });

                // 继承根记录按钮
                document.getElementById('inherit-btn').addEventListener('click', inheritRootRecords);

                // 排序和筛选
                document.getElementById('sort-select').addEventListener('change', () => {
                    sortRecords();
                    renderRecordsTable();
                });
                
                document.getElementById('filter-select').addEventListener('change', () => {
                    renderRecordsTable();
                });

                // 选择/取消选择按钮
                document.getElementById('select-all-btn').addEventListener('click', selectAllRecords);
                document.getElementById('deselect-all-btn').addEventListener('click', deselectAllRecords);
                document.getElementById('delete-selected-btn').addEventListener('click', deleteSelectedRecords);
                
                // 全选复选框
                document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectAllRecords();
                    } else {
                        deselectAllRecords();
                    }
                });

                // 月份选择相关
                document.getElementById('change-month-btn').addEventListener('click', () => {
                    document.getElementById('month-modal').classList.remove('hidden');
                    document.getElementById('selected-month').value = currentMonth;
                });
                
                document.getElementById('close-month-modal').addEventListener('click', () => {
                    document.getElementById('month-modal').classList.add('hidden');
                });
                
                document.getElementById('confirm-month').addEventListener('click', () => {
                    const newMonth = document.getElementById('selected-month').value;
                    if (newMonth && newMonth !== currentMonth) {
                        currentMonth = newMonth;
                        document.getElementById('current-month-display').textContent = formatMonth(currentMonth);
                        // 只有当前是月度记录时，才重新加载数据
                        if (currentRecordType === 'monthly') {
                            // 停止当前监听器
                            if (window.firebase.syncListener) {
                                window.firebase.syncListener();
                            }
                            // 加载新月份数据并设置新监听器
                            loadRecordsFromFirebase();
                            setupFirebaseListener();
                        }
                    }
                    document.getElementById('month-modal').classList.add('hidden');
                });

                // 分页相关
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderRecordsTable();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    const filteredRecords = getFilteredRecords();
                    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderRecordsTable();
                    }
                });
                
                document.getElementById('prev-page-mobile').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderRecordsTable();
                    }
                });
                
                document.getElementById('next-page-mobile').addEventListener('click', () => {
                    const filteredRecords = getFilteredRecords();
                    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderRecordsTable();
                    }
                });

                // 记录表单相关
                document.getElementById('close-modal').addEventListener('click', closeRecordModal);
                document.getElementById('cancel-form').addEventListener('click', closeRecordModal);
                document.getElementById('record-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveRecordForm();
                });

                // 标签输入时实时检查
                document.getElementById('tag').addEventListener('input', checkTagUniqueness);

                // 下载模态框相关
                document.getElementById('close-download-modal').addEventListener('click', () => {
                    document.getElementById('download-modal').classList.add('hidden');
                });
                
                document.getElementById('confirm-download').addEventListener('click', () => {
                    confirmDownload();
                    document.getElementById('download-modal').classList.add('hidden');
                });

                // 文件导入相关
                document.getElementById('import-file').addEventListener('change', handleFileImport);

                // 自动计算得分
                ['prosperity', 'leagueTotal', 'actualTimes', 'totalStars', 'destructionRate'].forEach(field => {
                    document.getElementById(field).addEventListener('input', calculateScore);
                });

                // 表格行事件委托
                document.getElementById('records-table-body').addEventListener('click', (e) => {
                    // 处理编辑按钮
                    if (e.target.closest('.edit-record')) {
                        const recordId = e.target.closest('.edit-record').getAttribute('data-id');
                        openRecordModal(recordId);
                    }
                    
                    // 处理删除按钮
                    if (e.target.closest('.delete-record')) {
                        const recordId = e.target.closest('.delete-record').getAttribute('data-id');
                        if (confirm('确定要删除这条记录吗？')) {
                            deleteRecord(recordId);
                        }
                    }
                    
                    // 处理记录复选框
                    if (e.target.classList.contains('record-checkbox')) {
                        const recordId = e.target.getAttribute('data-id');
                        if (e.target.checked) {
                            selectedRecords.add(recordId);
                        } else {
                            selectedRecords.delete(recordId);
                        }
                        updateSelectAllCheckbox();
                    }
                });
            }

            // 检查标签唯一性
            function checkTagUniqueness() {
                const tagInput = document.getElementById('tag');
                const tagError = document.getElementById('tag-error');
                const currentTag = tagInput.value.trim();
                const recordId = document.getElementById('record-id').value;
                
                // 空标签不检查（允许空标签，因为空标签不会重复冲突）
                if (!currentTag) {
                    tagError.classList.add('hidden');
                    tagInput.classList.remove('border-danger');
                    return true;
                }
                
                // 检查是否有其他记录使用相同标签
                const tagExists = currentRecords.some(record => {
                    // 编辑时排除自身记录
                    if (recordId && record.id === recordId) {
                        return false;
                    }
                    return record.tag === currentTag;
                });
                
                if (tagExists) {
                    tagError.classList.remove('hidden');
                    tagInput.classList.add('border-danger');
                    return false;
                } else {
                    tagError.classList.add('hidden');
                    tagInput.classList.remove('border-danger');
                    return true;
                }
            }

            // 切换记录类型
            function switchRecordType(type) {
                currentRecordType = type;
                currentPage = 1;
                selectedRecords.clear();
                
                // 停止当前的Firebase同步
                if (window.firebase.syncListener) {
                    window.firebase.syncListener();
                }
                
                // 更新按钮样式
                if (type === 'root') {
                    document.getElementById('root-records-btn').classList.remove('btn-inactive');
                    document.getElementById('root-records-btn').classList.add('btn-active');
                    document.getElementById('monthly-records-btn').classList.remove('btn-active');
                    document.getElementById('monthly-records-btn').classList.add('btn-inactive');
                } else {
                    document.getElementById('root-records-btn').classList.remove('btn-active');
                    document.getElementById('root-records-btn').classList.add('btn-inactive');
                    document.getElementById('monthly-records-btn').classList.remove('btn-inactive');
                    document.getElementById('monthly-records-btn').classList.add('btn-active');
                }
                
                // 加载对应类型的记录并设置新的监听器
                loadRecordsFromFirebase();
                setupFirebaseListener();
            }

            // 打开记录模态框
            function openRecordModal(recordId = null) {
                const modalTitle = document.getElementById('modal-title');
                const recordIdInput = document.getElementById('record-id');
                const tagInput = document.getElementById('tag');
                const tagError = document.getElementById('tag-error');
                
                // 重置表单
                document.getElementById('record-form').reset();
                document.querySelector('input[name="inClan"][value="true"]').checked = true;
                document.getElementById('score').value = '';
                tagError.classList.add('hidden');
                tagInput.classList.remove('border-danger');
                
                if (recordId) {
                    // 编辑现有记录
                    modalTitle.textContent = '编辑记录';
                    const record = currentRecords.find(r => r.id === recordId);
                    if (record) {
                        recordIdInput.value = record.id;
                        document.getElementById('prosperity').value = record.prosperity || '';
                        document.getElementById('name').value = record.name || '';
                        document.getElementById('tag').value = record.tag || '';
                        document.getElementById('position').value = record.position || '';
                        document.getElementById('maxTrophies').value = record.maxTrophies || '';
                        document.getElementById('joinDate').value = record.joinDate || '';
                        document.getElementById('leagueTotal').value = record.leagueTotal || '';
                        document.getElementById('actualTimes').value = record.actualTimes || '';
                        document.getElementById('totalStars').value = record.totalStars || '';
                        document.getElementById('destructionRate').value = record.destructionRate || '';
                        document.getElementById('score').value = record.score || '';
                        document.getElementById('evaluation').value = record.evaluation || '';
                        document.querySelector(`input[name="inClan"][value="${record.inClan}"]`).checked = true;
                    }
                } else {
                    // 添加新记录
                    modalTitle.textContent = '添加记录';
                    recordIdInput.value = '';
                    // 设置默认日期为今天
                    document.getElementById('joinDate').value = new Date().toISOString().split('T')[0];
                }
                
                document.getElementById('record-modal').classList.remove('hidden');
            }

            // 关闭记录模态框
            function closeRecordModal() {
                document.getElementById('record-modal').classList.add('hidden');
            }

            // 保存记录表单
            function saveRecordForm() {
                // 先检查标签唯一性
                if (!checkTagUniqueness()) {
                    return; // 如果标签不唯一，阻止保存
                }
                
                const recordId = document.getElementById('record-id').value;
                const recordData = {
                    prosperity: parseFloat(document.getElementById('prosperity').value) || 0,
                    name: document.getElementById('name').value.trim(),
                    tag: document.getElementById('tag').value.trim(),
                    position: document.getElementById('position').value,
                    maxTrophies: parseInt(document.getElementById('maxTrophies').value) || 0,
                    joinDate: document.getElementById('joinDate').value,
                    leagueTotal: parseInt(document.getElementById('leagueTotal').value) || 0,
                    actualTimes: parseInt(document.getElementById('actualTimes').value) || 0,
                    totalStars: parseInt(document.getElementById('totalStars').value) || 0,
                    destructionRate: parseFloat(document.getElementById('destructionRate').value) || 0,
                    score: parseFloat(document.getElementById('score').value) || 0,
                    evaluation: document.getElementById('evaluation').value,
                    inClan: document.querySelector('input[name="inClan"]:checked').value === 'true'
                };

                // 验证必要字段
                if (!recordData.name) {
                    showToast('请输入名字', 'warning');
                    return;
                }

                if (recordId) {
                    // 更新现有记录
                    const index = currentRecords.findIndex(r => r.id === recordId);
                    if (index !== -1) {
                        recordData.id = recordId;
                        currentRecords[index] = recordData;
                        showToast('记录已更新', 'success');
                    }
                } else {
                    // 添加新记录
                    recordData.id = generateId();
                    currentRecords.push(recordData);
                    showToast('记录已添加', 'success');
                }

                // 保存并刷新表格 - 会自动同步到Firebase
                saveRecordsToLocalStorage();
                sortRecords();
                renderRecordsTable();
                updateSummaryCards();
                closeRecordModal();
            }

            // 生成唯一ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            // 计算得分
            function calculateScore() {
                const prosperity = parseFloat(document.getElementById('prosperity').value) || 0;
                const leagueTotal = parseInt(document.getElementById('leagueTotal').value) || 0;
                const actualTimes = parseInt(document.getElementById('actualTimes').value) || 0;
                const totalStars = parseInt(document.getElementById('totalStars').value) || 0;
                const destructionRate = parseFloat(document.getElementById('destructionRate').value) || 0;

                // 简单的得分计算公式
                let score = 0;
                if (leagueTotal > 0) {
                    // 出勤率占30%
                    const attendanceRate = (actualTimes / leagueTotal) * 30;
                    // 星星效率占30%
                    const starEfficiency = (totalStars / actualTimes) * 30 / 3; // 假设每场最多3星
                    // 摧毁率占20%
                    const destructionScore = (destructionRate / 100) * 20;
                    // 繁荣度占20%
                    const prosperityScore = (prosperity / 10000) * 20; // 假设最大繁荣度为10000
                    
                    score = attendanceRate + starEfficiency + destructionScore + prosperityScore;
                }

                document.getElementById('score').value = score.toFixed(4);
            }

            // 获取筛选后的记录
            function getFilteredRecords() {
                const filterValue = document.getElementById('filter-select').value;
                
                return currentRecords.filter(record => {
                    if (filterValue === 'in-clan') {
                        return record.inClan;
                    } else if (filterValue === 'out-clan') {
                        return !record.inClan;
                    }
                    return true; // 全部
                });
            }

            // 排序记录
            function sortRecords() {
                const sortValue = document.getElementById('sort-select').value;
                
                currentRecords.sort((a, b) => {
                    switch (sortValue) {
                        case 'prosperity':
                            return b.prosperity - a.prosperity;
                        case 'score':
                            return b.score - a.score;
                        case 'position':
                            const positionOrder = { 'leader': 4, 'coLeader': 3, 'elder': 2, 'member': 1, '': 0 };
                            return positionOrder[b.position] - positionOrder[a.position];
                        case 'evaluation':
                            const evaluationOrder = { 'powerhouse': 4, 'highQuality': 3, 'backbone': 2, 'potential': 1, '': 0 };
                            return evaluationOrder[b.evaluation] - evaluationOrder[a.evaluation];
                        default:
                            return 0;
                    }
                });
            }

            // 渲染记录表格
            function renderRecordsTable() {
                const tableBody = document.getElementById('records-table-body');
                const filteredRecords = getFilteredRecords();
                const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                const startIndex = (currentPage - 1) * recordsPerPage;
                const endIndex = Math.min(startIndex + recordsPerPage, filteredRecords.length);
                const currentRecordsToShow = filteredRecords.slice(startIndex, endIndex);

                // 更新分页信息
                document.getElementById('total-records').textContent = filteredRecords.length;
                document.getElementById('current-range').textContent = filteredRecords.length > 0 
                    ? `${startIndex + 1}-${endIndex}` 
                    : '0-0';
                
                // 生成页码
                const pageNumbersContainer = document.getElementById('page-numbers');
                pageNumbersContainer.innerHTML = '';
                
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium ${i === currentPage ? 'z-10 bg-primary/10 text-primary border-primary' : 'text-gray-700 hover:bg-gray-50'}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        renderRecordsTable();
                    });
                    pageNumbersContainer.appendChild(pageBtn);
                }
                
                // 显示或隐藏分页控件
                if (filteredRecords.length <= recordsPerPage) {
                    document.getElementById('pagination').classList.add('hidden');
                } else {
                    document.getElementById('pagination').classList.remove('hidden');
                }

                // 清空表格
                tableBody.innerHTML = '';

                if (currentRecordsToShow.length === 0) {
                    // 显示空状态
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'text-center';
                    emptyRow.innerHTML = `
                        <td colspan="15" class="px-4 py-8 text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                <p>暂无记录，请添加或导入数据</p>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(emptyRow);
                    updateSelectAllCheckbox();
                    return;
                }

                // 添加记录行
                currentRecordsToShow.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    // 职位文本映射
                    const positionMap = {
                        'leader': '首领',
                        'coLeader': '副首领',
                        'elder': '长老',
                        'member': '成员',
                        '': '未知'
                    };
                    
                    // 评测文本映射
                    const evaluationMap = {
                        'powerhouse': '实力派',
                        'highQuality': '优质',
                        'backbone': '中坚',
                        'potential': '潜力股',
                        '': '未评测'
                    };

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="checkbox" class="record-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.prosperity.toFixed(0)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.tag || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${positionMap[record.position]}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.maxTrophies}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${formatDate(record.joinDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.leagueTotal}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.actualTimes}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.totalStars}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.destructionRate.toFixed(2)}%</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.score.toFixed(4)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${evaluationMap[record.evaluation]}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${record.inClan ? 'bg-success/10 text-success' : 'bg-gray-100 text-gray-800'}">
                                ${record.inClan ? '是' : '否'}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-record text-primary hover:text-primary/80 mr-3" data-id="${record.id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-record text-danger hover:text-danger/80" data-id="${record.id}">
                                <i class="fa fa-trash-o"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });

                // 更新全选复选框状态
                updateSelectAllCheckbox();
            }

            // 格式化日期
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            }

            // 更新全选复选框状态
            function updateSelectAllCheckbox() {
                const filteredRecords = getFilteredRecords();
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                
                if (filteredRecords.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.disabled = true;
                } else {
                    selectAllCheckbox.disabled = false;
                    const allSelected = filteredRecords.every(record => selectedRecords.has(record.id));
                    selectAllCheckbox.checked = allSelected;
                }
            }

            // 全选记录
            function selectAllRecords() {
                const filteredRecords = getFilteredRecords();
                filteredRecords.forEach(record => {
                    selectedRecords.add(record.id);
                });
                renderRecordsTable();
            }

            // 取消全选
            function deselectAllRecords() {
                selectedRecords.clear();
                renderRecordsTable();
            }

            // 删除选中记录
            function deleteSelectedRecords() {
                if (selectedRecords.size === 0) {
                    showToast('请先选择要删除的记录', 'warning');
                    return;
                }
                
                if (confirm(`确定要删除选中的 ${selectedRecords.size} 条记录吗？`)) {
                    currentRecords = currentRecords.filter(record => !selectedRecords.has(record.id));
                    selectedRecords.clear();
                    saveRecordsToLocalStorage(); // 会自动同步到Firebase
                    renderRecordsTable();
                    updateSummaryCards();
                    showToast(`已删除 ${selectedRecords.size} 条记录`, 'success');
                }
            }

            // 删除单条记录
            function deleteRecord(recordId) {
                currentRecords = currentRecords.filter(record => record.id !== recordId);
                selectedRecords.delete(recordId);
                saveRecordsToLocalStorage(); // 会自动同步到Firebase
                renderRecordsTable();
                updateSummaryCards();
                showToast('记录已删除', 'success');
            }

            // 更新摘要卡片
            function updateSummaryCards() {
                const totalCount = currentRecords.length;
                const inClanCount = currentRecords.filter(r => r.inClan).length;
                const totalScore = currentRecords.reduce((sum, r) => sum + (r.score || 0), 0);
                const averageScore = totalCount > 0 ? totalScore / totalCount : 0;

                document.getElementById('total-records-count').textContent = totalCount;
                document.getElementById('in-clan-count').textContent = inClanCount;
                document.getElementById('average-score').textContent = averageScore.toFixed(4);
            }

            // 继承根记录（手动添加根记录到月度记录）
            function inheritRootRecords() {
                if (currentRecordType === 'root') {
                    showToast('当前已是根记录，无需继承', 'warning');
                    return;
                }
                
                try {
                    // 从Firebase加载根记录
                    const { db, ref, get } = window.firebase;
                    const rootRef = ref(db, 'root-records');
                    
                    get(rootRef)
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                const rootRecords = snapshot.val();
                                
                                if (Array.isArray(rootRecords) && rootRecords.length > 0) {
                                    // 过滤掉与当前月度记录中标签重复的记录
                                    const existingTags = currentRecords.map(r => r.tag).filter(Boolean);
                                    const newRecords = rootRecords
                                        .filter(record => !existingTags.includes(record.tag) || !record.tag)
                                        .map(record => ({ ...record, id: generateId() })); // 生成新ID避免冲突
                                    
                                    currentRecords = [...currentRecords, ...newRecords];
                                    saveRecordsToLocalStorage(); // 会自动同步到Firebase
                                    renderRecordsTable();
                                    updateSummaryCards();
                                    
                                    showToast(`已成功继承 ${newRecords.length} 条根记录（跳过 ${rootRecords.length - newRecords.length} 个重复标签）`, 'success');
                                } else {
                                    showToast('没有可继承的根记录', 'warning');
                                }
                            } else {
                                showToast('没有可继承的根记录', 'warning');
                            }
                        })
                        .catch((error) => {
                            console.error('加载根记录失败:', error);
                            showToast(`加载根记录失败: ${error.message}`, 'error');
                        });
                } catch (e) {
                    console.error('继承根记录失败:', e);
                    showToast('继承根记录失败: ' + e.message, 'error');
                }
            }

            // 导出选中记录
            function exportSelectedRecords() {
                if (selectedRecords.size === 0) {
                    showToast('请先选择要导出的记录', 'warning');
                    return;
                }
                
                const recordsToExport = currentRecords.filter(record => selectedRecords.has(record.id));
                prepareExport(recordsToExport);
            }

            // 导出所有记录
            function exportAllRecords() {
                if (currentRecords.length === 0) {
                    showToast('没有可导出的记录', 'warning');
                    return;
                }
                
                prepareExport(currentRecords);
            }

            // 准备导出
            function prepareExport(records) {
                window.recordsToExport = records;
                document.getElementById('download-modal').classList.remove('hidden');
            }

            // 确认下载
            function confirmDownload() {
                const format = document.querySelector('input[name="download-format"]:checked').value;
                const records = window.recordsToExport;
                
                if (!records || records.length === 0) {
                    showToast('没有可导出的记录', 'warning');
                    return;
                }
                
                let content = '';
                let fileName = currentRecordType === 'root' 
                    ? 'root-records' 
                    : `monthly-records-${currentMonth}`;
                
                if (format === 'json') {
                    content = JSON.stringify(records, null, 2);
                    fileName += '.json';
                } else if (format === 'csv') {
                    content = convertToCSV(records);
                    fileName += '.csv';
                }
                
                // 创建并下载文件
                const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast(`已导出 ${records.length} 条记录到本地`, 'success');
                window.recordsToExport = null;
            }

            // 转换为CSV格式
            function convertToCSV(records) {
                if (records.length === 0) return '';
                
                // CSV表头
                const headers = [
                    '繁荣', '名字', '标签', '职位', '历史最高奖杯', '加入时间',
                    '联赛总次数', '实际次数', '总星数', '摧毁率(%)', '得分', '评测', '是否在部落'
                ];
                
                // 转换记录数据
                const rows = records.map(record => {
                    const positionMap = { 'leader': '首领', 'coLeader': '副首领', 'elder': '长老', 'member': '成员', '': '未知' };
                    const evaluationMap = { 'powerhouse': '实力派', 'highQuality': '优质', 'backbone': '中坚', 'potential': '潜力股', '': '未评测' };
                    
                    return [
                        record.prosperity || '',
                        `"${(record.name || '').replace(/"/g, '""')}"`,
                        `"${(record.tag || '').replace(/"/g, '""')}"`,
                        positionMap[record.position] || '',
                        record.maxTrophies || '',
                        record.joinDate || '',
                        record.leagueTotal || '',
                        record.actualTimes || '',
                        record.totalStars || '',
                        record.destructionRate || '',
                        record.score || '',
                        evaluationMap[record.evaluation] || '',
                        record.inClan ? '是' : '否'
                    ];
                });
                
                // 组合成CSV
                return [headers.join(',')].concat(rows.map(row => row.join(','))).join('\n');
            }

            // 处理文件导入（本地导入）
            function handleFileImport(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                let totalImported = 0;
                let duplicateTags = [];
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        try {
                            let importedRecords;
                            
                            if (file.name.endsWith('.json')) {
                                importedRecords = JSON.parse(event.target.result);
                            } else if (file.name.endsWith('.csv')) {
                                importedRecords = convertCSVToRecords(event.target.result);
                            } else {
                                showToast(`不支持的文件格式: ${file.name}`, 'error');
                                return;
                            }
                            
                            if (Array.isArray(importedRecords) && importedRecords.length > 0) {
                                // 过滤掉标签已存在的记录
                                const validRecords = importedRecords.filter(record => {
                                    const tagExists = currentRecords.some(r => r.tag === record.tag && record.tag);
                                    if (tagExists && record.tag) {
                                        duplicateTags.push(record.tag);
                                        return false;
                                    }
                                    return true;
                                });
                                
                                const newRecords = validRecords.map(record => ({
                                    ...record,
                                    id: generateId()
                                }));
                                
                                currentRecords = [...currentRecords, ...newRecords];
                                totalImported += newRecords.length;
                                
                                saveRecordsToLocalStorage(); // 会自动同步到Firebase
                                sortRecords();
                                renderRecordsTable();
                                updateSummaryCards();
                                
                                let message = `已从本地导入 ${newRecords.length} 条记录`;
                                if (duplicateTags.length > 0) {
                                    message += `，跳过 ${duplicateTags.length} 个重复标签: ${duplicateTags.slice(0, 5).join(', ')}${duplicateTags.length > 5 ? '...' : ''}`;
                                }
                                showToast(message, 'success');
                            } else {
                                showToast(`文件 ${file.name} 中没有有效数据`, 'warning');
                            }
                        } catch (error) {
                            console.error(`导入文件 ${file.name} 失败:`, error);
                            showToast(`导入 ${file.name} 失败: ${error.message}`, 'error');
                        }
                    };
                    
                    if (file.name.endsWith('.json') || file.name.endsWith('.csv')) {
                        reader.readAsText(file);
                    } else {
                        showToast(`请导入JSON或CSV文件，跳过 ${file.name}`, 'warning');
                    }
                });
                
                // 重置文件输入
                e.target.value = '';
            }

            // 将CSV转换为记录数组
            function convertCSVToRecords(csvContent) {
                const lines = csvContent.split('\n');
                if (lines.length < 2) return [];
                
                // 跳过表头行
                const dataLines = lines.slice(1);
                
                return dataLines.filter(line => line.trim() !== '').map(line => {
                    const parts = line.split(',');
                    
                    const positionMap = { '首领': 'leader', '副首领': 'coLeader', '长老': 'elder', '成员': 'member', '未知': '' };
                    const evaluationMap = { '实力派': 'powerhouse', '优质': 'highQuality', '中坚': 'backbone', '潜力股': 'potential', '未评测': '' };
                    
                    return {
                        prosperity: parseFloat(parts[0]) || 0,
                        name: parts[1] ? parts[1].replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"') : '',
                        tag: parts[2] ? parts[2].replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"') : '',
                        position: positionMap[parts[3]] || '',
                        maxTrophies: parseInt(parts[4]) || 0,
                        joinDate: parts[5] || '',
                        leagueTotal: parseInt(parts[6]) || 0,
                        actualTimes: parseInt(parts[7]) || 0,
                        totalStars: parseInt(parts[8]) || 0,
                        destructionRate: parseFloat(parts[9]) || 0,
                        score: parseFloat(parts[10]) || 0,
                        evaluation: evaluationMap[parts[11]] || '',
                        inClan: parts[12] === '是'
                    };
                });
            }

            // 显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastIcon = document.getElementById('toast-icon');
                const toastMessage = document.getElementById('toast-message');

                toastMessage.textContent = message;
                toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center';

                if (type === 'success') {
                    toast.classList.add('bg-success', 'text-white');
                    toastIcon.className = 'fa fa-check-circle mr-2';
                } else if (type === 'error') {
                    toast.classList.add('bg-danger', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-circle mr-2';
                } else if (type === 'warning') {
                    toast.classList.add('bg-warning', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-triangle mr-2';
                } else {
                    toast.classList.add('bg-primary', 'text-white');
                    toastIcon.className = 'fa fa-info-circle mr-2';
                }

                // 显示提示
                setTimeout(() => {
                    toast.classList.remove('translate-y-20', 'opacity-0');
                }, 10);

                // 3秒后隐藏
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }
        })();
    </script>
</body>
</html>