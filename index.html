<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大明朱雀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        info: '#40A9FF',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-active {
                @apply bg-primary/10 text-primary border-primary/20;
            }
            .btn-inactive {
                @apply bg-white text-gray-600 border-gray-200;
            }
        }
    </style>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  import { getDatabase, ref, set, get, push, remove, update } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyB40MBHZ3U6xPG_N1ulqVqeZGZnBCbSAWg",
    authDomain: "share-notes-1b48c.firebaseapp.com",
    projectId: "share-notes-1b48c",
    storageBucket: "share-notes-1b48c.firebasestorage.app",
    messagingSenderId: "99459795397",
    appId: "1:99459795397:web:1a727e631c50f840fbe3ac",
    measurementId: "G-09DG9T1FGB"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  // Initialize Realtime Database
  const db = getDatabase(app);
  
  // 导出数据库引用供全局使用
  window.firebaseDb = {
    db,
    ref,
    set,
    get,
    push,
    remove,
    update
  };
</script>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 密码验证页面 -->
    <div id="password-page" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-primary/10">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">大明朱雀</h2>
                <p class="text-gray-500 mt-2">请输入密钥</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码计算</label>
                    <div class="relative">
                        <input type="text" id="password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="#2QQGGU888">
                        <button id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <p id="password-error" class="text-danger text-sm mt-1 hidden">撸晕了吗</p>
                </div>
                
                <button id="login-btn" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300">
                    撸
                </button>
            </div>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="app" class="hidden flex flex-col h-screen">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-bar-chart text-primary text-xl"></i>
                    <h1 class="text-lg font-bold text-gray-800">大明朱雀</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span id="current-month-display" class="text-sm text-gray-600"></span>
                        <button id="change-month-btn" class="text-primary hover:text-primary/80 text-sm flex items-center">
                            <i class="fa fa-calendar-o mr-1"></i> 切换月份
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
            <!-- 记录类型切换 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">记录类型：</span>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="root-records-btn" class="px-4 py-2 text-sm font-medium rounded-l-lg border transition-colors btn-active">
                                根记录
                            </button>
                            <button type="button" id="monthly-records-btn" class="px-4 py-2 text-sm font-medium rounded-r-lg border transition-colors btn-inactive">
                                月度记录
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <button id="add-record-btn" class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors shadow-sm">
                            <i class="fa fa-plus mr-2"></i> 添加记录
                        </button>
                        
                        <div class="relative inline-block">
                            <button id="import-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-upload mr-2"></i> 导入
                            </button>
                            <div id="import-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="import-single-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">单个导入</button>
                                <button id="import-batch-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">批量导入</button>
                                <button id="import-from-firebase-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fa fa-cloud-download mr-1"></i> 从云端导入
                                </button>
                            </div>
                        </div>
                        
                        <div class="relative inline-block">
                            <button id="export-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-download mr-2"></i> 导出
                            </button>
                            <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="export-selected-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出选中</button>
                                <button id="export-all-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出全部</button>
                                <button id="export-to-firebase-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fa fa-cloud-upload mr-1"></i> 保存到云端
                                </button>
                            </div>
                        </div>
                        
                        <button id="inherit-btn" class="inline-flex items-center px-4 py-2 bg-success text-white text-sm font-medium rounded-lg hover:bg-success/90 transition-colors shadow-sm">
                            <i class="fa fa-clone mr-2"></i> 继承根记录
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 排序和筛选 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">排序方式：</span>
                            <select id="sort-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="prosperity">按繁荣值高低</option>
                                <option value="score">按得分值高低</option>
                                <option value="position">按职位优先级</option>
                                <option value="evaluation">按评测优先级</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">筛选：</span>
                            <select id="filter-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="all">全部</option>
                                <option value="in-clan">仅在部落</option>
                                <option value="out-clan">不在部落</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="select-all-btn" class="text-sm text-primary hover:text-primary/80">
                            <i class="fa fa-check-square-o mr-1"></i> 全选
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="deselect-all-btn" class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fa fa-square-o mr-1"></i> 取消选择
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="delete-selected-btn" class="text-sm text-danger hover:text-danger/80">
                            <i class="fa fa-trash-o mr-1"></i> 删除选中
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 数据表格 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 w-12">
                                    <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                                </th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">繁荣</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名字</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标签</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职位</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">历史最高奖杯</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">加入时间</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联赛总次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">实际次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总星数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">摧毁率</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">得分</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">评测</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">是否在部落</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                            <tr class="text-center">
                                <td colspan="15" class="px-4 py-8 text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                        <p>暂无记录，请添加或导入数据</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div id="pagination" class="px-4 py-3 flex items-center justify-between border-t border-gray-200 bg-white hidden">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prev-page-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            上一页
                        </button>
                        <button id="next-page-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            下一页
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                显示第 <span id="current-range" class="font-medium">1-10</span> 条，共 <span id="total-records" class="font-medium">0</span> 条记录
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">上一页</span>
                                    <i class="fa fa-chevron-left text-xs"></i>
                                </button>
                                <div id="page-numbers" class="flex">
                                    <!-- 页码将动态生成 -->
                                </div>
                                <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">下一页</span>
                                    <i class="fa fa-chevron-right text-xs"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据预览卡片 -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-primary">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">总记录数</h3>
                        <i class="fa fa-database text-primary"></i>
                    </div>
                    <p id="total-records-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-success">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">在部落成员</h3>
                        <i class="fa fa-users text-success"></i>
                    </div>
                    <p id="in-clan-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-warning">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">平均得分</h3>
                        <i class="fa fa-line-chart text-warning"></i>
                    </div>
                    <p id="average-score" class="mt-1 text-2xl font-semibold text-gray-900">0.0000</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 添加/编辑记录模态框 -->
    <div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" id="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900">添加记录</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="record-form" class="p-6 space-y-4">
                <input type="hidden" id="record-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="prosperity" class="block text-sm font-medium text-gray-700 mb-1">繁荣</label>
                        <input type="number" id="prosperity" step="any"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入繁荣值">
                    </div>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">名字</label>
                        <input type="text" id="name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入名字">
                    </div>
                    
                    <div>
                        <label for="tag" class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                        <input type="text" id="tag"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入标签">
                    </div>
                    
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700 mb-1">职位</label>
                        <select id="position" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择职位</option>
                            <option value="leader">首领</option>
                            <option value="coLeader">副首领</option>
                            <option value="elder">长老</option>
                            <option value="member">成员</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="maxTrophies" class="block text-sm font-medium text-gray-700 mb-1">历史最高奖杯数</label>
                        <input type="number" id="maxTrophies"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入历史最高奖杯数">
                    </div>
                    
                    <div>
                        <label for="joinDate" class="block text-sm font-medium text-gray-700 mb-1">加入起始时间</label>
                        <input type="date" id="joinDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                    </div>
                    
                    <div>
                        <label for="leagueTotal" class="block text-sm font-medium text-gray-700 mb-1">当月联赛总次数</label>
                        <input type="number" id="leagueTotal" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入联赛总次数">
                    </div>
                    
                    <div>
                        <label for="actualTimes" class="block text-sm font-medium text-gray-700 mb-1">实际次数</label>
                        <input type="number" id="actualTimes" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入实际次数">
                    </div>
                    
                    <div>
                        <label for="totalStars" class="block text-sm font-medium text-gray-700 mb-1">总星数</label>
                        <input type="number" id="totalStars" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入总星数">
                    </div>
                    
                    <div>
                        <label for="destructionRate" class="block text-sm font-medium text-gray-700 mb-1">摧毁率 (%)</label>
                        <input type="number" id="destructionRate" step="0.01" min="0" max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入摧毁率">
                    </div>
                    
                    <div>
                        <label for="score" class="block text-sm font-medium text-gray-700 mb-1">得分 (自动计算)</label>
                        <input type="text" id="score" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                               placeholder="自动计算">
                    </div>
                    
                    <div>
                        <label for="evaluation" class="block text-sm font-medium text-gray-700 mb-1">评测</label>
                        <select id="evaluation" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择评测</option>
                            <option value="powerhouse">实力派</option>
                            <option value="highQuality">优质</option>
                            <option value="backbone">中坚</option>
                            <option value="potential">潜力股</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">是否在部落</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="true" class="text-primary focus:ring-primary h-4 w-4" checked>
                            <span class="ml-2 text-sm text-gray-700">是</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="false" class="text-primary focus:ring-primary h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">否</span>
                        </label>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" id="cancel-form" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 下载格式选择模态框 -->
    <div id="download-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="download-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择下载格式</h3>
                    <button id="close-download-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="json" checked class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">JSON 格式 (.json)</span>
                    </label>
                    
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="csv" class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">CSV 格式 (.csv)</span>
                    </label>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-download" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认下载
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 月份选择模态框 -->
    <div id="month-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="month-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择月份</h3>
                    <button id="close-month-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label for="selected-month" class="block text-sm font-medium text-gray-700 mb-1">选择月份</label>
                    <input type="month" id="selected-month"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-month" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入文件输入框（隐藏） -->
    <input type="file" id="import-file" accept=".json,.csv" class="hidden">

    <!-- 提示消息组件 -->
    <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <i id="toast-icon" class="mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        // 登录逻辑
        (function() {
            const passwordPage = document.getElementById('password-page');
            const app = document.getElementById('app');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const passwordError = document.getElementById('password-error');
            const togglePassword = document.getElementById('toggle-password');

            // 绑定登录按钮点击事件（确保优先执行）
            loginBtn.addEventListener('click', () => {
                console.log('登录按钮点击');
                validatePassword();
            }, { capture: true });
            
            // 回车键登录
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    validatePassword();
                }
            });

            // 密码可见性切换
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                console.log('密码可见性切换');
            });

            function validatePassword() {
                const input = passwordInput.value.trim();
                passwordError.classList.add('hidden');
                passwordInput.classList.remove('border-danger');
                
                if (!input) {
                    showError('别撸了害怕');
                    return;
                }
                
                try {
                    // 替换运算符并计算
                    const expr = input.replace(/a/g, '*').replace(/b/g, '/').replace(/c/g, '+').replace(/d/g, '-');
                    const result = eval(expr);
                    
                    if (Math.abs(result - 7) < 0.0001) {
                        passwordPage.classList.add('hidden');
                        app.classList.remove('hidden');
                        initMainApp();
                        showToast('出货', 'success');
                    } else {
                        showError(`并非${result.toFixed(2)}，你撸眼花了`);
                    }
                } catch (e) {
                    showError('换个姿势呢');
                }
            }

            function showError(message) {
                passwordError.textContent = message;
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-danger');
                setTimeout(() => passwordInput.classList.remove('border-danger'), 1000);
            }

            // 显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastIcon = document.getElementById('toast-icon');
                const toastMessage = document.getElementById('toast-message');

                toastMessage.textContent = message;
                toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center';

                if (type === 'success') {
                    toast.classList.add('bg-success', 'text-white');
                    toastIcon.className = 'fa fa-check-circle mr-2';
                } else if (type === 'error') {
                    toast.classList.add('bg-danger', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-circle mr-2';
                } else if (type === 'warning') {
                    toast.classList.add('bg-warning', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-triangle mr-2';
                } else {
                    toast.classList.add('bg-primary', 'text-white');
                    toastIcon.className = 'fa fa-info-circle mr-2';
                }

                // 显示提示
                setTimeout(() => {
                    toast.classList.remove('translate-y-20', 'opacity-0');
                }, 10);

                // 3秒后隐藏
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            // 主应用初始化
            function initMainApp() {
                // 初始化数据存储
                let records = [];
                let currentMonth = new Date().toISOString().slice(0, 7);
                let currentRecordType = 'root'; // 'root' 或 'monthly'
                let selectedRecords = new Set();
                let currentPage = 1;
                const recordsPerPage = 10;

                // 更新当前月份显示
                document.getElementById('current-month-display').textContent = formatMonth(currentMonth);
                
                // 初始化月份选择器
                document.getElementById('selected-month').value = currentMonth;

                // 记录类型切换
                document.getElementById('root-records-btn').addEventListener('click', () => {
                    currentRecordType = 'root';
                    document.getElementById('root-records-btn').classList.remove('btn-inactive');
                    document.getElementById('root-records-btn').classList.add('btn-active');
                    document.getElementById('monthly-records-btn').classList.remove('btn-active');
                    document.getElementById('monthly-records-btn').classList.add('btn-inactive');
                    loadRecords();
                });

                document.getElementById('monthly-records-btn').addEventListener('click', () => {
                    currentRecordType = 'monthly';
                    document.getElementById('monthly-records-btn').classList.remove('btn-inactive');
                    document.getElementById('monthly-records-btn').classList.add('btn-active');
                    document.getElementById('root-records-btn').classList.remove('btn-active');
                    document.getElementById('root-records-btn').classList.add('btn-inactive');
                    loadRecords();
                });

                // 月份选择相关
                document.getElementById('change-month-btn').addEventListener('click', () => {
                    document.getElementById('month-modal').classList.remove('hidden');
                });

                document.getElementById('close-month-modal').addEventListener('click', () => {
                    document.getElementById('month-modal').classList.add('hidden');
                });

                document.getElementById('confirm-month').addEventListener('click', () => {
                    const selectedMonth = document.getElementById('selected-month').value;
                    if (selectedMonth) {
                        currentMonth = selectedMonth;
                        document.getElementById('current-month-display').textContent = formatMonth(currentMonth);
                        document.getElementById('month-modal').classList.add('hidden');
                        loadRecords();
                    }
                });

                // 导入/导出下拉菜单
                document.getElementById('import-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('import-dropdown').classList.toggle('hidden');
                    document.getElementById('export-dropdown').classList.add('hidden');
                });

                document.getElementById('export-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('export-dropdown').classList.toggle('hidden');
                    document.getElementById('import-dropdown').classList.add('hidden');
                });

                // 点击其他地方关闭下拉菜单
                document.addEventListener('click', () => {
                    document.getElementById('import-dropdown').classList.add('hidden');
                    document.getElementById('export-dropdown').classList.add('hidden');
                });

                // 阻止下拉菜单内部点击事件冒泡
                document.getElementById('import-dropdown').addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                document.getElementById('export-dropdown').addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // 添加记录按钮
                document.getElementById('add-record-btn').addEventListener('click', () => {
                    document.getElementById('modal-title').textContent = '添加记录';
                    document.getElementById('record-form').reset();
                    document.getElementById('record-id').value = '';
                    document.getElementById('score').value = '';
                    document.querySelector('input[name="inClan"][value="true"]').checked = true;
                    document.getElementById('record-modal').classList.remove('hidden');
                });

                // 关闭模态框
                document.getElementById('close-modal').addEventListener('click', () => {
                    document.getElementById('record-modal').classList.add('hidden');
                });

                document.getElementById('cancel-form').addEventListener('click', () => {
                    document.getElementById('record-modal').classList.add('hidden');
                });

                // 表单提交
                document.getElementById('record-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveRecord();
                });

                // 导入导出功能
                document.getElementById('import-single-btn').addEventListener('click', () => {
                    document.getElementById('import-dropdown').classList.add('hidden');
                    document.getElementById('import-file').click();
                });

                document.getElementById('import-batch-btn').addEventListener('click', () => {
                    document.getElementById('import-dropdown').classList.add('hidden');
                    document.getElementById('import-file').click();
                });

                document.getElementById('import-file').addEventListener('change', handleFileImport);

                document.getElementById('export-selected-btn').addEventListener('click', () => {
                    document.getElementById('export-dropdown').classList.add('hidden');
                    if (selectedRecords.size === 0) {
                        showToast('请先选择要导出的记录', 'warning');
                        return;
                    }
                    const selected = records.filter(record => selectedRecords.has(record.id));
                    exportRecords(selected);
                });

                document.getElementById('export-all-btn').addEventListener('click', () => {
                    document.getElementById('export-dropdown').classList.add('hidden');
                    if (records.length === 0) {
                        showToast('没有记录可导出', 'warning');
                        return;
                    }
                    exportRecords(records);
                });

                // Firebase 云端操作
                document.getElementById('import-from-firebase-btn').addEventListener('click', async () => {
                    document.getElementById('import-dropdown').classList.add('hidden');
                    try {
                        showToast('正在从云端导入数据...', 'info');
                        const data = await importFromFirebase();
                        if (data && data.length > 0) {
                            records = data;
                            saveRecordsToStorage();
                            renderRecords();
                            updateStatistics();
                            showToast(`成功从云端导入 ${data.length} 条记录`, 'success');
                        } else {
                            showToast('云端没有找到记录', 'info');
                        }
                    } catch (error) {
                        console.error('从云端导入失败:', error);
                        showToast('从云端导入失败，请重试', 'error');
                    }
                });

                document.getElementById('export-to-firebase-btn').addEventListener('click', async () => {
                    document.getElementById('export-dropdown').classList.add('hidden');
                    if (records.length === 0) {
                        showToast('没有记录可保存到云端', 'warning');
                        return;
                    }
                    try {
                        showToast('正在保存到云端...', 'info');
                        await exportToFirebase(records);
                        showToast(`成功保存 ${records.length} 条记录到云端`, 'success');
                    } catch (error) {
                        console.error('保存到云端失败:', error);
                        showToast('保存到云端失败，请重试', 'error');
                    }
                });

                // 继承根记录
                document.getElementById('inherit-btn').addEventListener('click', () => {
                    if (currentRecordType === 'root') {
                        showToast('当前已是根记录，无需继承', 'warning');
                        return;
                    }
                    
                    // 加载根记录
                    const rootRecords = JSON.parse(localStorage.getItem('root-records') || '[]');
                    if (rootRecords.length === 0) {
                        showToast('没有可继承的根记录', 'warning');
                        return;
                    }
                    
                    // 继承根记录（复制一份作为月度记录）
                    records = rootRecords.map(record => {
                        // 创建新对象，避免引用问题
                        return { ...record, id: generateId() };
                    });
                    
                    saveRecordsToStorage();
                    renderRecords();
                    updateStatistics();
                    showToast(`成功继承 ${records.length} 条根记录`, 'success');
                });

                // 排序和筛选
                document.getElementById('sort-select').addEventListener('change', renderRecords);
                document.getElementById('filter-select').addEventListener('change', renderRecords);

                // 选择功能
                document.getElementById('select-all-btn').addEventListener('click', () => {
                    const filteredRecords = getFilteredRecords();
                    filteredRecords.forEach(record => selectedRecords.add(record.id));
                    renderRecords();
                });

                document.getElementById('deselect-all-btn').addEventListener('click', () => {
                    selectedRecords.clear();
                    renderRecords();
                });

                document.getElementById('delete-selected-btn').addEventListener('click', () => {
                    if (selectedRecords.size === 0) {
                        showToast('请先选择要删除的记录', 'warning');
                        return;
                    }
                    
                    if (confirm(`确定要删除选中的 ${selectedRecords.size} 条记录吗？`)) {
                        records = records.filter(record => !selectedRecords.has(record.id));
                        selectedRecords.clear();
                        saveRecordsToStorage();
                        renderRecords();
                        updateStatistics();
                        showToast(`已删除 ${selectedRecords.size} 条记录`, 'success');
                    }
                });

                document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                    const filteredRecords = getFilteredRecords();
                    if (e.target.checked) {
                        filteredRecords.forEach(record => selectedRecords.add(record.id));
                    } else {
                        filteredRecords.forEach(record => selectedRecords.delete(record.id));
                    }
                    renderRecords();
                });

                // 分页控制
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderRecords();
                    }
                });

                document.getElementById('next-page').addEventListener('click', () => {
                    const filteredRecords = getFilteredRecords();
                    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderRecords();
                    }
                });

                document.getElementById('prev-page-mobile').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderRecords();
                    }
                });

                document.getElementById('next-page-mobile').addEventListener('click', () => {
                    const filteredRecords = getFilteredRecords();
                    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderRecords();
                    }
                });

                // 下载模态框控制
                document.getElementById('close-download-modal').addEventListener('click', () => {
                    document.getElementById('download-modal').classList.add('hidden');
                });

                // 确认下载
                document.getElementById('confirm-download').addEventListener('click', () => {
                    const format = document.querySelector('input[name="download-format"]:checked').value;
                    const dataToExport = window.dataToExport || [];
                    if (dataToExport.length > 0) {
                        downloadFile(dataToExport, format);
                        document.getElementById('download-modal').classList.add('hidden');
                    }
                });

                // 加载记录
                function loadRecords() {
                    const storageKey = currentRecordType === 'root' ? 'root-records' : `monthly-records-${currentMonth}`;
                    const savedRecords = localStorage.getItem(storageKey);
                    records = savedRecords ? JSON.parse(savedRecords) : [];
                    currentPage = 1;
                    renderRecords();
                    updateStatistics();
                }

                // 保存记录到本地存储
                function saveRecordsToStorage() {
                    const storageKey = currentRecordType === 'root' ? 'root-records' : `monthly-records-${currentMonth}`;
                    localStorage.setItem(storageKey, JSON.stringify(records));
                }

                // 从Firebase导入数据
                async function importFromFirebase() {
                    const { db, ref, get } = window.firebaseDb;
                    const storageKey = currentRecordType === 'root' ? 'root-records' : `monthly-records-${currentMonth}`;
                    const recordsRef = ref(db, storageKey);
                    
                    const snapshot = await get(recordsRef);
                    if (snapshot.exists()) {
                        return snapshot.val();
                    }
                    return [];
                }

                // 导出数据到Firebase
                async function exportToFirebase(data) {
                    const { db, ref, set } = window.firebaseDb;
                    const storageKey = currentRecordType === 'root' ? 'root-records' : `monthly-records-${currentMonth}`;
                    const recordsRef = ref(db, storageKey);
                    
                    await set(recordsRef, data);
                }

                // 保存记录
                function saveRecord() {
                    const id = document.getElementById('record-id').value;
                    const prosperity = parseFloat(document.getElementById('prosperity').value) || 0;
                    const name = document.getElementById('name').value.trim();
                    const tag = document.getElementById('tag').value.trim();
                    const position = document.getElementById('position').value;
                    const maxTrophies = parseInt(document.getElementById('maxTrophies').value) || 0;
                    const joinDate = document.getElementById('joinDate').value;
                    const leagueTotal = parseInt(document.getElementById('leagueTotal').value) || 0;
                    const actualTimes = parseInt(document.getElementById('actualTimes').value) || 0;
                    const totalStars = parseInt(document.getElementById('totalStars').value) || 0;
                    const destructionRate = parseFloat(document.getElementById('destructionRate').value) || 0;
                    const evaluation = document.getElementById('evaluation').value;
                    const inClan = document.querySelector('input[name="inClan"]:checked').value === 'true';

                    // 简单验证
                    if (!name) {
                        showToast('请输入名字', 'warning');
                        return;
                    }

                    // 计算得分 (示例计算方式)
                    const score = calculateScore(prosperity, maxTrophies, leagueTotal, actualTimes, totalStars, destructionRate, position);

                    const record = {
                        prosperity,
                        name,
                        tag,
                        position,
                        maxTrophies,
                        joinDate,
                        leagueTotal,
                        actualTimes,
                        totalStars,
                        destructionRate,
                        score,
                        evaluation,
                        inClan,
                        updatedAt: new Date().toISOString()
                    };

                    if (id) {
                        // 更新现有记录
                        const index = records.findIndex(r => r.id === id);
                        if (index !== -1) {
                            record.id = id;
                            records[index] = record;
                            showToast('记录已更新', 'success');
                        }
                    } else {
                        // 添加新记录
                        record.id = generateId();
                        records.unshift(record);
                        showToast('记录已添加', 'success');
                    }

                    saveRecordsToStorage();
                    document.getElementById('record-modal').classList.add('hidden');
                    renderRecords();
                    updateStatistics();
                }

                // 计算得分
                function calculateScore(prosperity, maxTrophies, leagueTotal, actualTimes, totalStars, destructionRate, position) {
                    // 简单的得分计算逻辑，可根据实际需求调整
                    let score = 0;
                    
                    // 繁荣值占比
                    score += prosperity * 0.2;
                    
                    // 奖杯数占比
                    score += maxTrophies * 0.1;
                    
                    // 联赛参与度占比
                    if (leagueTotal > 0) {
                        score += (actualTimes / leagueTotal) * 100 * 0.2;
                    }
                    
                    // 星星数占比
                    score += totalStars * 0.2;
                    
                    // 摧毁率占比
                    score += destructionRate * 0.2;
                    
                    // 职位加成
                    const positionBonus = {
                        'leader': 10,
                        'coLeader': 8,
                        'elder': 5,
                        'member': 0
                    };
                    score += positionBonus[position] || 0;
                    
                    return parseFloat(score.toFixed(4));
                }

                // 渲染记录表格
                function renderRecords() {
                    const tableBody = document.getElementById('records-table-body');
                    const filteredRecords = getFilteredRecords();
                    const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
                    const startIndex = (currentPage - 1) * recordsPerPage;
                    const paginatedRecords = filteredRecords.slice(startIndex, startIndex + recordsPerPage);

                    // 更新全选复选框状态
                    const selectAllCheckbox = document.getElementById('select-all-checkbox');
                    selectAllCheckbox.checked = filteredRecords.length > 0 && 
                                               selectedRecords.size === filteredRecords.length;

                    if (paginatedRecords.length === 0) {
                        tableBody.innerHTML = `
                            <tr class="text-center">
                                <td colspan="15" class="px-4 py-8 text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                        <p>暂无记录，请添加或导入数据</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = paginatedRecords.map(record => `
                            <tr>
                                <td class="px-4 py-3">
                                    <input type="checkbox" class="record-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                                </td>
                                <td class="px-4 py-3">${record.prosperity}</td>
                                <td class="px-4 py-3">${record.name}</td>
                                <td class="px-4 py-3">${record.tag || '-'}</td>
                                <td class="px-4 py-3">${formatPosition(record.position)}</td>
                                <td class="px-4 py-3">${record.maxTrophies}</td>
                                <td class="px-4 py-3">${record.joinDate || '-'}</td>
                                <td class="px-4 py-3">${record.leagueTotal}</td>
                                <td class="px-4 py-3">${record.actualTimes}</td>
                                <td class="px-4 py-3">${record.totalStars}</td>
                                <td class="px-4 py-3">${record.destructionRate}%</td>
                                <td class="px-4 py-3">${record.score}</td>
                                <td class="px-4 py-3">${formatEvaluation(record.evaluation)}</td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded-full ${record.inClan ? 'bg-success/10 text-success' : 'bg-gray-100 text-gray-500'}">
                                        ${record.inClan ? '是' : '否'}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-medium">
                                    <button class="text-primary hover:text-primary/80 mr-3 edit-record" data-id="${record.id}">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="text-danger hover:text-danger/80 delete-record" data-id="${record.id}">
                                        <i class="fa fa-trash-o"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');

                        // 绑定复选框事件
                        document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', (e) => {
                                const id = e.target.getAttribute('data-id');
                                if (e.target.checked) {
                                    selectedRecords.add(id);
                                } else {
                                    selectedRecords.delete(id);
                                }
                                // 更新全选复选框状态
                                selectAllCheckbox.checked = filteredRecords.length > 0 && 
                                                           selectedRecords.size === filteredRecords.length;
                            });
                        });

                        // 绑定编辑事件
                        document.querySelectorAll('.edit-record').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const id = e.target.closest('.edit-record').getAttribute('data-id');
                                editRecord(id);
                            });
                        });

                        // 绑定删除事件
                        document.querySelectorAll('.delete-record').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const id = e.target.closest('.delete-record').getAttribute('data-id');
                                deleteRecord(id);
                            });
                        });
                    }

                    // 更新分页
                    updatePagination(filteredRecords.length, totalPages);
                }

                // 获取筛选后的记录
                function getFilteredRecords() {
                    const sortBy = document.getElementById('sort-select').value;
                    const filterBy = document.getElementById('filter-select').value;

                    // 筛选
                    let filtered = [...records];
                    
                    if (filterBy === 'in-clan') {
                        filtered = filtered.filter(record => record.inClan);
                    } else if (filterBy === 'out-clan') {
                        filtered = filtered.filter(record => !record.inClan);
                    }

                    // 排序
                    filtered.sort((a, b) => {
                        switch (sortBy) {
                            case 'prosperity':
                                return b.prosperity - a.prosperity;
                            case 'score':
                                return b.score - a.score;
                            case 'position':
                                const positionOrder = { 'leader': 4, 'coLeader': 3, 'elder': 2, 'member': 1, '': 0 };
                                return positionOrder[b.position] - positionOrder[a.position];
                            case 'evaluation':
                                const evaluationOrder = { 'powerhouse': 4, 'highQuality': 3, 'backbone': 2, 'potential': 1, '': 0 };
                                return evaluationOrder[b.evaluation] - evaluationOrder[a.evaluation];
                            default:
                                return 0;
                        }
                    });

                    return filtered;
                }

                // 更新分页控件
                function updatePagination(totalRecords, totalPages) {
                    const paginationContainer = document.getElementById('pagination');
                    const pageNumbersContainer = document.getElementById('page-numbers');
                    const currentRangeElement = document.getElementById('current-range');
                    const totalRecordsElement = document.getElementById('total-records');

                    if (totalRecords === 0) {
                        paginationContainer.classList.add('hidden');
                        return;
                    }

                    paginationContainer.classList.remove('hidden');
                    totalRecordsElement.textContent = totalRecords;

                    // 更新当前范围显示
                    const start = (currentPage - 1) * recordsPerPage + 1;
                    const end = Math.min(currentPage * recordsPerPage, totalRecords);
                    currentRangeElement.textContent = `${start}-${end}`;

                    // 更新页码
                    pageNumbersContainer.innerHTML = '';
                    
                    // 只显示当前页附近的页码
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, currentPage + 2);
                    
                    // 确保至少显示5个页码（除非总页数少于5）
                    if (endPage - startPage < 4 && totalPages >= 5) {
                        if (startPage === 1) {
                            endPage = 5;
                        } else if (endPage === totalPages) {
                            startPage = totalPages - 4;
                        }
                    }
                    
                    // 添加第一页
                    if (startPage > 1) {
                        addPageNumber(1);
                        if (startPage > 2) {
                            addEllipsis();
                        }
                    }
                    
                    // 添加中间页码
                    for (let i = startPage; i <= endPage; i++) {
                        addPageNumber(i);
                    }
                    
                    // 添加最后一页
                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            addEllipsis();
                        }
                        addPageNumber(totalPages);
                    }

                    // 禁用/启用上一页/下一页按钮
                    document.getElementById('prev-page').disabled = currentPage === 1;
                    document.getElementById('next-page').disabled = currentPage === totalPages;
                    document.getElementById('prev-page-mobile').disabled = currentPage === 1;
                    document.getElementById('next-page-mobile').disabled = currentPage === totalPages;

                    if (currentPage === 1) {
                        document.getElementById('prev-page').classList.add('opacity-50', 'cursor-not-allowed');
                        document.getElementById('prev-page-mobile').classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        document.getElementById('prev-page').classList.remove('opacity-50', 'cursor-not-allowed');
                        document.getElementById('prev-page-mobile').classList.remove('opacity-50', 'cursor-not-allowed');
                    }

                    if (currentPage === totalPages) {
                        document.getElementById('next-page').classList.add('opacity-50', 'cursor-not-allowed');
                        document.getElementById('next-page-mobile').classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        document.getElementById('next-page').classList.remove('opacity-50', 'cursor-not-allowed');
                        document.getElementById('next-page-mobile').classList.remove('opacity-50', 'cursor-not-allowed');
                    }

                    function addPageNumber(page) {
                        const button = document.createElement('button');
                        button.className = `relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium ${
                            page === currentPage ? 'z-10 bg-primary text-white border-primary' : 'text-gray-700 hover:bg-gray-50'
                        }`;
                        button.textContent = page;
                        button.addEventListener('click', () => {
                            currentPage = page;
                            renderRecords();
                        });
                        pageNumbersContainer.appendChild(button);
                    }

                    function addEllipsis() {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700';
                        ellipsis.textContent = '...';
                        pageNumbersContainer.appendChild(ellipsis);
                    }
                }

                // 更新统计信息
                function updateStatistics() {
                    const totalRecordsCount = document.getElementById('total-records-count');
                    const inClanCount = document.getElementById('in-clan-count');
                    const averageScore = document.getElementById('average-score');

                    totalRecordsCount.textContent = records.length;
                    
                    const inClan = records.filter(record => record.inClan).length;
                    inClanCount.textContent = inClan;
                    
                    if (records.length > 0) {
                        const totalScore = records.reduce((sum, record) => sum + record.score, 0);
                        averageScore.textContent = (totalScore / records.length).toFixed(4);
                    } else {
                        averageScore.textContent = '0.0000';
                    }
                }

                // 编辑记录
                function editRecord(id) {
                    const record = records.find(r => r.id === id);
                    if (record) {
                        document.getElementById('modal-title').textContent = '编辑记录';
                        document.getElementById('record-id').value = record.id;
                        document.getElementById('prosperity').value = record.prosperity;
                        document.getElementById('name').value = record.name;
                        document.getElementById('tag').value = record.tag || '';
                        document.getElementById('position').value = record.position || '';
                        document.getElementById('maxTrophies').value = record.maxTrophies;
                        document.getElementById('joinDate').value = record.joinDate || '';
                        document.getElementById('leagueTotal').value = record.leagueTotal;
                        document.getElementById('actualTimes').value = record.actualTimes;
                        document.getElementById('totalStars').value = record.totalStars;
                        document.getElementById('destructionRate').value = record.destructionRate;
                        document.getElementById('score').value = record.score;
                        document.getElementById('evaluation').value = record.evaluation || '';
                        document.querySelector(`input[name="inClan"][value="${record.inClan}"]`).checked = true;
                        
                        document.getElementById('record-modal').classList.remove('hidden');
                    }
                }

                // 删除记录
                function deleteRecord(id) {
                    if (confirm('确定要删除这条记录吗？')) {
                        records = records.filter(record => record.id !== id);
                        selectedRecords.delete(id);
                        saveRecordsToStorage();
                        renderRecords();
                        updateStatistics();
                        showToast('记录已删除', 'success');
                    }
                }

                // 处理文件导入
                function handleFileImport(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        try {
                            let importedRecords;
                            
                            if (file.name.endsWith('.json')) {
                                importedRecords = JSON.parse(event.target.result);
                            } else if (file.name.endsWith('.csv')) {
                                importedRecords = csvToJson(event.target.result);
                            } else {
                                showToast('不支持的文件格式', 'error');
                                return;
                            }
                            
                            if (Array.isArray(importedRecords) && importedRecords.length > 0) {
                                // 为导入的记录生成新ID，避免冲突
                                const newRecords = importedRecords.map(record => ({
                                    ...record,
                                    id: generateId(),
                                    updatedAt: new Date().toISOString()
                                }));
                                
                                records = [...records, ...newRecords];
                                saveRecordsToStorage();
                                renderRecords();
                                updateStatistics();
                                showToast(`成功导入 ${newRecords.length} 条记录`, 'success');
                            } else {
                                showToast('导入的数据格式不正确', 'error');
                            }
                        } catch (error) {
                            console.error('导入失败:', error);
                            showToast('导入失败，请检查文件格式', 'error');
                        }
                    };
                    
                    if (file.name.endsWith('.json')) {
                        reader.readAsText(file);
                    } else if (file.name.endsWith('.csv')) {
                        reader.readAsText(file);
                    }
                    
                    // 重置文件输入，允许重复选择同一个文件
                    document.getElementById('import-file').value = '';
                }

                // 导出记录
                function exportRecords(data) {
                    window.dataToExport = data;
                    document.getElementById('download-modal').classList.remove('hidden');
                }

                // 下载文件
                function downloadFile(data, format) {
                    let content, mimeType, extension;
                    
                    if (format === 'json') {
                        content = JSON.stringify(data, null, 2);
                        mimeType = 'application/json';
                        extension = 'json';
                    } else if (format === 'csv') {
                        content = jsonToCsv(data);
                        mimeType = 'text/csv';
                        extension = 'csv';
                    }
                    
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentRecordType}-records-${currentMonth}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast(`已导出 ${data.length} 条记录`, 'success');
                }

                // JSON转CSV
                function jsonToCsv(json) {
                    if (!json || json.length === 0) return '';
                    
                    const headers = Object.keys(json[0]);
                    const csv = [
                        headers.join(','),
                        ...json.map(row => headers.map(field => {
                            const value = row[field];
                            // 处理包含逗号或引号的值
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(','))
                    ].join('\n');
                    
                    return csv;
                }

                // CSV转JSON
                function csvToJson(csv) {
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(header => header.trim());
                    const result = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i]) continue;
                        
                        const values = parseCsvLine(lines[i]);
                        const obj = {};
                        
                        for (let j = 0; j < headers.length; j++) {
                            if (j < values.length) {
                                obj[headers[j]] = values[j];
                            }
                        }
                        
                        // 转换数据类型
                        if (obj.prosperity) obj.prosperity = parseFloat(obj.prosperity);
                        if (obj.maxTrophies) obj.maxTrophies = parseInt(obj.maxTrophies);
                        if (obj.leagueTotal) obj.leagueTotal = parseInt(obj.leagueTotal);
                        if (obj.actualTimes) obj.actualTimes = parseInt(obj.actualTimes);
                        if (obj.totalStars) obj.totalStars = parseInt(obj.totalStars);
                        if (obj.destructionRate) obj.destructionRate = parseFloat(obj.destructionRate);
                        if (obj.score) obj.score = parseFloat(obj.score);
                        if (obj.inClan) obj.inClan = obj.inClan === 'true' || obj.inClan === '是';
                        
                        result.push(obj);
                    }
                    
                    return result;
                }

                // 解析CSV行（处理包含逗号和引号的字段）
                function parseCsvLine(line) {
                    const values = [];
                    let currentValue = '';
                    let inQuotes = false;
                    let quoteCount = 0;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            quoteCount++;
                            // 如果是连续两个引号，则视为一个引号
                            if (i < line.length - 1 && line[i + 1] === '"') {
                                currentValue += '"';
                                i++; // 跳过下一个引号
                                quoteCount = 0;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue.trim());
                            currentValue = '';
                            quoteCount = 0;
                        } else {
                            currentValue += char;
                        }
                    }
                    
                    // 添加最后一个值
                    values.push(currentValue.trim());
                    
                    return values;
                }

                // 生成唯一ID
                function generateId() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                }

                // 格式化月份显示
                function formatMonth(monthString) {
                    const [year, month] = monthString.split('-');
                    return `${year}年${parseInt(month)}月`;
                }

                // 格式化职位显示
                function formatPosition(position) {
                    const positionMap = {
                        'leader': '首领',
                        'coLeader': '副首领',
                        'elder': '长老',
                        'member': '成员'
                    };
                    return positionMap[position] || '-';
                }

                // 格式化评测显示
                function formatEvaluation(evaluation) {
                    const evaluationMap = {
                        'powerhouse': '实力派',
                        'highQuality': '优质',
                        'backbone': '中坚',
                        'potential': '潜力股'
                    };
                    return evaluationMap[evaluation] || '-';
                }

                // 初始化页面
                loadRecords();
            }
        })();
    </script>
</body>
</html>