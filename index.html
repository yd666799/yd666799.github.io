<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大明朱雀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        info: '#40A9FF',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-active {
                @apply bg-primary/10 text-primary border-primary/20;
            }
            .btn-inactive {
                @apply bg-white text-gray-600 border-gray-200;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 密码验证页面 -->
    <div id="password-page" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary/5 to-primary/10">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">大明朱雀</h2>
                <p class="text-gray-500 mt-2">请输入密钥</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码计算</label>
                    <div class="relative">
                        <input type="text" id="password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="#2QQGGU888">
                        <button id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <p id="password-error" class="text-danger text-sm mt-1 hidden">撸晕了吗</p>
                </div>
                
                <button id="login-btn" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300">
                    撸
                </button>
            </div>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="app" class="hidden flex flex-col h-screen">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-bar-chart text-primary text-xl"></i>
                    <h1 class="text-lg font-bold text-gray-800">大明朱雀</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span id="current-month-display" class="text-sm text-gray-600"></span>
                        <button id="change-month-btn" class="text-primary hover:text-primary/80 text-sm flex items-center">
                            <i class="fa fa-calendar-o mr-1"></i> 切换月份
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
            <!-- 记录类型切换 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">记录类型：</span>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="root-records-btn" class="px-4 py-2 text-sm font-medium rounded-l-lg border transition-colors btn-active">
                                根记录
                            </button>
                            <button type="button" id="monthly-records-btn" class="px-4 py-2 text-sm font-medium rounded-r-lg border transition-colors btn-inactive">
                                月度记录
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <button id="add-record-btn" class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors shadow-sm">
                            <i class="fa fa-plus mr-2"></i> 添加记录
                        </button>
                        
                        <div class="relative inline-block">
                            <button id="import-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-upload mr-2"></i> 导入
                            </button>
                            <div id="import-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="import-single-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">单个导入</button>
                                <button id="import-batch-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">批量导入</button>
                            </div>
                        </div>
                        
                        <div class="relative inline-block">
                            <button id="export-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors shadow-sm">
                                <i class="fa fa-download mr-2"></i> 导出
                            </button>
                            <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                <button id="export-selected-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出选中</button>
                                <button id="export-all-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出全部</button>
                            </div>
                        </div>
                        
                        <button id="inherit-btn" class="inline-flex items-center px-4 py-2 bg-success text-white text-sm font-medium rounded-lg hover:bg-success/90 transition-colors shadow-sm">
                            <i class="fa fa-clone mr-2"></i> 继承根记录
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 排序和筛选 -->
            <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">排序方式：</span>
                            <select id="sort-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="prosperity">按繁荣值高低</option>
                                <option value="score">按得分值高低</option>
                                <option value="position">按职位优先级</option>
                                <option value="evaluation">按评测优先级</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">筛选：</span>
                            <select id="filter-select" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="all">全部</option>
                                <option value="in-clan">仅在部落</option>
                                <option value="out-clan">不在部落</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="select-all-btn" class="text-sm text-primary hover:text-primary/80">
                            <i class="fa fa-check-square-o mr-1"></i> 全选
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="deselect-all-btn" class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fa fa-square-o mr-1"></i> 取消选择
                        </button>
                        <span class="text-gray-400">|</span>
                        <button id="delete-selected-btn" class="text-sm text-danger hover:text-danger/80">
                            <i class="fa fa-trash-o mr-1"></i> 删除选中
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 数据表格 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 w-12">
                                    <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                                </th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">繁荣</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名字</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标签</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">职位</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">历史最高奖杯</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">加入时间</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联赛总次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">实际次数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总星数</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">摧毁率</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">得分</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">评测</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">是否在部落</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                            <tr class="text-center">
                                <td colspan="15" class="px-4 py-8 text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                        <p>暂无记录，请添加或导入数据</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div id="pagination" class="px-4 py-3 flex items-center justify-between border-t border-gray-200 bg-white hidden">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prev-page-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            上一页
                        </button>
                        <button id="next-page-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            下一页
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                显示第 <span id="current-range" class="font-medium">1-10</span> 条，共 <span id="total-records" class="font-medium">0</span> 条记录
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">上一页</span>
                                    <i class="fa fa-chevron-left text-xs"></i>
                                </button>
                                <div id="page-numbers" class="flex">
                                    <!-- 页码将动态生成 -->
                                </div>
                                <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">下一页</span>
                                    <i class="fa fa-chevron-right text-xs"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据预览卡片 -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-primary">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">总记录数</h3>
                        <i class="fa fa-database text-primary"></i>
                    </div>
                    <p id="total-records-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-success">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">在部落成员</h3>
                        <i class="fa fa-users text-success"></i>
                    </div>
                    <p id="in-clan-count" class="mt-1 text-2xl font-semibold text-gray-900">0</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-warning">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">平均得分</h3>
                        <i class="fa fa-line-chart text-warning"></i>
                    </div>
                    <p id="average-score" class="mt-1 text-2xl font-semibold text-gray-900">0.0000</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 添加/编辑记录模态框 -->
    <div id="record-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" id="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900">添加记录</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="record-form" class="p-6 space-y-4">
                <input type="hidden" id="record-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="prosperity" class="block text-sm font-medium text-gray-700 mb-1">繁荣</label>
                        <input type="number" id="prosperity" step="any"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入繁荣值">
                    </div>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">名字</label>
                        <input type="text" id="name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入名字">
                    </div>
                    
                    <div>
                        <label for="tag" class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                        <input type="text" id="tag"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入标签">
                    </div>
                    
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700 mb-1">职位</label>
                        <select id="position" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择职位</option>
                            <option value="leader">首领</option>
                            <option value="coLeader">副首领</option>
                            <option value="elder">长老</option>
                            <option value="member">成员</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="maxTrophies" class="block text-sm font-medium text-gray-700 mb-1">历史最高奖杯数</label>
                        <input type="number" id="maxTrophies"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入历史最高奖杯数">
                    </div>
                    
                    <div>
                        <label for="joinDate" class="block text-sm font-medium text-gray-700 mb-1">加入起始时间</label>
                        <input type="date" id="joinDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                    </div>
                    
                    <div>
                        <label for="leagueTotal" class="block text-sm font-medium text-gray-700 mb-1">当月联赛总次数</label>
                        <input type="number" id="leagueTotal" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入联赛总次数">
                    </div>
                    
                    <div>
                        <label for="actualTimes" class="block text-sm font-medium text-gray-700 mb-1">实际次数</label>
                        <input type="number" id="actualTimes" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入实际次数">
                    </div>
                    
                    <div>
                        <label for="totalStars" class="block text-sm font-medium text-gray-700 mb-1">总星数</label>
                        <input type="number" id="totalStars" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入总星数">
                    </div>
                    
                    <div>
                        <label for="destructionRate" class="block text-sm font-medium text-gray-700 mb-1">摧毁率 (%)</label>
                        <input type="number" id="destructionRate" step="0.01" min="0" max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                               placeholder="输入摧毁率">
                    </div>
                    
                    <div>
                        <label for="score" class="block text-sm font-medium text-gray-700 mb-1">得分 (自动计算)</label>
                        <input type="text" id="score" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed"
                               placeholder="自动计算">
                    </div>
                    
                    <div>
                        <label for="evaluation" class="block text-sm font-medium text-gray-700 mb-1">评测</label>
                        <select id="evaluation" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                            <option value="">请选择评测</option>
                            <option value="powerhouse">实力派</option>
                            <option value="highQuality">优质</option>
                            <option value="backbone">中坚</option>
                            <option value="potential">潜力股</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">是否在部落</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="true" class="text-primary focus:ring-primary h-4 w-4" checked>
                            <span class="ml-2 text-sm text-gray-700">是</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="inClan" value="false" class="text-primary focus:ring-primary h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">否</span>
                        </label>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" id="cancel-form" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 下载格式选择模态框 -->
    <div id="download-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="download-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择下载格式</h3>
                    <button id="close-download-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="json" checked class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">JSON 格式 (.json)</span>
                    </label>
                    
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="radio" name="download-format" value="csv" class="text-primary focus:ring-primary h-4 w-4">
                        <span class="ml-3 text-gray-700">CSV 格式 (.csv)</span>
                    </label>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-download" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认下载
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 月份选择模态框 -->
    <div id="month-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md" id="month-modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">选择月份</h3>
                    <button id="close-month-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label for="selected-month" class="block text-sm font-medium text-gray-700 mb-1">选择月份</label>
                    <input type="month" id="selected-month"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none">
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-month" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入文件输入框（隐藏） -->
    <input type="file" id="import-file" accept=".json,.csv" class="hidden">

    <!-- 提示消息组件 -->
    <div id="toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <i id="toast-icon" class="mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        // 登录逻辑
        (function() {
            const passwordPage = document.getElementById('password-page');
            const app = document.getElementById('app');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const passwordError = document.getElementById('password-error');
            const togglePassword = document.getElementById('toggle-password');

            // 绑定登录按钮点击事件（确保优先执行）
            loginBtn.addEventListener('click', () => {
                console.log('登录按钮点击');
                validatePassword();
            }, { capture: true });
            
            // 回车键登录
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    validatePassword();
                }
            });

            // 密码可见性切换
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                console.log('密码可见性切换');
            });

            function validatePassword() {
                const input = passwordInput.value.trim();
                passwordError.classList.add('hidden');
                passwordInput.classList.remove('border-danger');
                
                if (!input) {
                    showError('别撸了害怕');
                    return;
                }
                
                try {
                    // 替换运算符并计算
                    const expr = input.replace(/a/g, '*').replace(/b/g, '/').replace(/c/g, '+').replace(/d/g, '-');
                    const result = eval(expr);
                    
                    if (Math.abs(result - 7) < 0.0001) {
                        passwordPage.classList.add('hidden');
                        app.classList.remove('hidden');
                        initMainApp();
                        showToast('出货', 'success');
                    } else {
                        showError(`并非${result.toFixed(2)}，你撸眼花了`);
                    }
                } catch (e) {
                    showError('换个姿势呢');
                }
            }

            function showError(message) {
                passwordError.textContent = message;
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-danger');
                setTimeout(() => passwordInput.classList.remove('border-danger'), 1000);
            }

            // 显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastIcon = document.getElementById('toast-icon');
                const toastMessage = document.getElementById('toast-message');

                toastMessage.textContent = message;
                toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center';

                if (type === 'success') {
                    toast.classList.add('bg-success', 'text-white');
                    toastIcon.className = 'fa fa-check-circle mr-2';
                } else if (type === 'error') {
                    toast.classList.add('bg-danger', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-circle mr-2';
                } else if (type === 'warning') {
                    toast.classList.add('bg-warning', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-triangle mr-2';
                } else {
                    toast.classList.add('bg-primary', 'text-white');
                    toastIcon.className = 'fa fa-info-circle mr-2';
                }

                setTimeout(() => {
                    toast.classList.remove('translate-y-20', 'opacity-0');
                }, 10);

                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }
        })();

        // 主应用逻辑
        function initMainApp() {
            console.log('主应用初始化');
            
            // 全局变量
            let currentRecords = []; // 月度记录
            let rootRecords = [];    // 根记录
            let currentMonth = new Date().toISOString().slice(0, 7); // 格式: yyyy-mm
            let currentRecordType = 'root'; // 'root' 或 'monthly'
            let selectedRecordIds = new Set();
            let currentPage = 1;
            const recordsPerPage = 10;

            // DOM元素缓存
            const elements = {
                // 表格和记录相关
                recordsTableBody: document.getElementById('records-table-body'),
                addRecordBtn: document.getElementById('add-record-btn'),
                recordModal: document.getElementById('record-modal'),
                closeModal: document.getElementById('close-modal'),
                cancelForm: document.getElementById('cancel-form'),
                recordForm: document.getElementById('record-form'),
                modalTitle: document.getElementById('modal-title'),
                recordIdInput: document.getElementById('record-id'),
                
                // 排序筛选
                sortSelect: document.getElementById('sort-select'),
                filterSelect: document.getElementById('filter-select'),
                selectAllCheckbox: document.getElementById('select-all-checkbox'),
                selectAllBtn: document.getElementById('select-all-btn'),
                deselectAllBtn: document.getElementById('deselect-all-btn'),
                deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                
                // 导入导出
                exportBtn: document.getElementById('export-btn'),
                exportDropdown: document.getElementById('export-dropdown'),
                exportSelectedBtn: document.getElementById('export-selected-btn'),
                exportAllBtn: document.getElementById('export-all-btn'),
                importBtn: document.getElementById('import-btn'),
                importDropdown: document.getElementById('import-dropdown'),
                importSingleBtn: document.getElementById('import-single-btn'),
                importBatchBtn: document.getElementById('import-batch-btn'),
                importFile: document.getElementById('import-file'),
                downloadModal: document.getElementById('download-modal'),
                closeDownloadModal: document.getElementById('close-download-modal'),
                confirmDownload: document.getElementById('confirm-download'),
                
                // 记录类型切换
                rootRecordsBtn: document.getElementById('root-records-btn'),
                monthlyRecordsBtn: document.getElementById('monthly-records-btn'),
                inheritBtn: document.getElementById('inherit-btn'),
                
                // 月份相关
                currentMonthDisplay: document.getElementById('current-month-display'),
                changeMonthBtn: document.getElementById('change-month-btn'),
                monthModal: document.getElementById('month-modal'),
                closeMonthModal: document.getElementById('close-month-modal'),
                confirmMonth: document.getElementById('confirm-month'),
                selectedMonthInput: document.getElementById('selected-month'),
                
                // 统计卡片
                totalRecordsCount: document.getElementById('total-records-count'),
                inClanCount: document.getElementById('in-clan-count'),
                averageScore: document.getElementById('average-score'),
                
                // 分页
                pagination: document.getElementById('pagination'),
                currentRange: document.getElementById('current-range'),
                totalRecords: document.getElementById('total-records'),
                pageNumbers: document.getElementById('page-numbers'),
                prevPage: document.getElementById('prev-page'),
                nextPage: document.getElementById('next-page'),
                prevPageMobile: document.getElementById('prev-page-mobile'),
                nextPageMobile: document.getElementById('next-page-mobile'),
                
                // 表单字段
                prosperityInput: document.getElementById('prosperity'),
                nameInput: document.getElementById('name'),
                tagInput: document.getElementById('tag'),
                positionInput: document.getElementById('position'),
                maxTrophiesInput: document.getElementById('maxTrophies'),
                joinDateInput: document.getElementById('joinDate'),
                leagueTotalInput: document.getElementById('leagueTotal'),
                actualTimesInput: document.getElementById('actualTimes'),
                totalStarsInput: document.getElementById('totalStars'),
                destructionRateInput: document.getElementById('destructionRate'),
                scoreInput: document.getElementById('score'),
                evaluationInput: document.getElementById('evaluation'),
            };

            // 初始化
            function init() {
                // 设置当前月份显示
                elements.currentMonthDisplay.textContent = formatMonth(currentMonth);
                elements.selectedMonthInput.value = currentMonth;
                
                // 绑定所有事件（核心修复：使用命名函数，避免匿名函数冲突）
                bindAllEvents();
                
                // 初始化本地存储数据
                loadFromLocalStorage();
                
                // 渲染页面
                renderRecords();
                updateStatistics();
            }

            // 绑定所有事件（关键修复：每个事件单独绑定，避免委托冲突）
            function bindAllEvents() {
                // 添加记录按钮
                elements.addRecordBtn.addEventListener('click', handleAddRecordClick);
                
                // 关闭模态框
                elements.closeModal.addEventListener('click', handleCloseModalClick);
                elements.cancelForm.addEventListener('click', handleCloseModalClick);
                
                // 表单提交
                elements.recordForm.addEventListener('submit', handleFormSubmit);
                
                // 记录类型切换
                elements.rootRecordsBtn.addEventListener('click', handleRootRecordsClick);
                elements.monthlyRecordsBtn.addEventListener('click', handleMonthlyRecordsClick);
                
                // 继承根记录
                elements.inheritBtn.addEventListener('click', handleInheritClick);
                
                // 全选/取消全选
                elements.selectAllBtn.addEventListener('click', handleSelectAllClick);
                elements.deselectAllBtn.addEventListener('click', handleDeselectAllClick);
                elements.selectAllCheckbox.addEventListener('change', handleSelectAllChange);
                
                // 删除选中
                elements.deleteSelectedBtn.addEventListener('click', handleDeleteSelectedClick);
                
                // 导出功能
                elements.exportBtn.addEventListener('click', handleExportBtnClick);
                elements.exportSelectedBtn.addEventListener('click', handleExportSelectedClick);
                elements.exportAllBtn.addEventListener('click', handleExportAllClick);
                
                // 导入功能
                elements.importBtn.addEventListener('click', handleImportBtnClick);
                elements.importSingleBtn.addEventListener('click', handleImportSingleClick);
                elements.importBatchBtn.addEventListener('click', handleImportBatchClick);
                elements.importFile.addEventListener('change', handleFileImport);
                
                // 月份选择
                elements.changeMonthBtn.addEventListener('click', handleChangeMonthClick);
                elements.closeMonthModal.addEventListener('click', handleCloseMonthModalClick);
                elements.confirmMonth.addEventListener('click', handleConfirmMonthClick);
                
                // 下载模态框
                elements.closeDownloadModal.addEventListener('click', handleCloseDownloadModalClick);
                elements.confirmDownload.addEventListener('click', handleConfirmDownloadClick);
                
                // 分页
                elements.prevPage.addEventListener('click', handlePrevPageClick);
                elements.nextPage.addEventListener('click', handleNextPageClick);
                elements.prevPageMobile.addEventListener('click', handlePrevPageClick);
                elements.nextPageMobile.addEventListener('click', handleNextPageClick);
                
                // 排序和筛选
                elements.sortSelect.addEventListener('change', handleSortChange);
                elements.filterSelect.addEventListener('change', handleFilterChange);
                
                // 自动计算得分
                elements.leagueTotalInput.addEventListener('input', calculateScore);
                elements.totalStarsInput.addEventListener('input', calculateScore);
                elements.positionInput.addEventListener('change', calculateScore);
                
                // 表格内按钮事件委托（单独处理，避免冲突）
                elements.recordsTableBody.addEventListener('click', handleTableClick);
                
                // 分页按钮事件委托
                elements.pageNumbers.addEventListener('click', handlePageNumberClick);
                
                // 点击空白处关闭下拉菜单
                document.addEventListener('click', handleDocumentClick);
            }

            // 事件处理函数（单独定义，便于调试和避免冲突）
            function handleAddRecordClick() {
                console.log('添加记录按钮点击');
                elements.modalTitle.textContent = '添加记录';
                elements.recordForm.reset();
                elements.recordIdInput.value = '';
                elements.scoreInput.value = '';
                document.querySelector('input[name="inClan"][value="true"]').checked = true;
                elements.recordModal.classList.remove('hidden');
            }

            function handleCloseModalClick() {
                console.log('关闭模态框');
                elements.recordModal.classList.add('hidden');
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                console.log('表单提交');
                saveRecord();
            }

            function handleRootRecordsClick() {
                console.log('切换到根记录');
                currentRecordType = 'root';
                updateRecordTypeButtons();
                renderRecords();
                showToast('已切换到根记录', 'info');
            }

            function handleMonthlyRecordsClick() {
                console.log('切换到月度记录');
                currentRecordType = 'monthly';
                updateRecordTypeButtons();
                renderRecords();
                showToast('已切换到月度记录', 'info');
            }

            function handleInheritClick() {
                console.log('继承根记录按钮点击');
                inheritRootRecords();
            }

            function handleSelectAllClick() {
                console.log('全选按钮点击');
                elements.selectAllCheckbox.checked = true;
                handleSelectAllChange();
            }

            function handleDeselectAllClick() {
                console.log('取消选择按钮点击');
                elements.selectAllCheckbox.checked = false;
                handleSelectAllChange();
            }

            function handleSelectAllChange() {
                console.log('全选框状态改变');
                const records = getFilteredRecords();
                const paginatedRecords = records.slice(
                    (currentPage - 1) * recordsPerPage,
                    currentPage * recordsPerPage
                );
                
                if (elements.selectAllCheckbox.checked) {
                    paginatedRecords.forEach(r => selectedRecordIds.add(r.id));
                } else {
                    paginatedRecords.forEach(r => selectedRecordIds.delete(r.id));
                }
                
                renderRecords();
            }

            function handleDeleteSelectedClick() {
                console.log('删除选中按钮点击');
                deleteSelectedRecords();
            }

            function handleExportBtnClick(e) {
                e.stopPropagation();
                console.log('导出按钮点击');
                elements.exportDropdown.classList.toggle('hidden');
            }

            function handleExportSelectedClick() {
                console.log('导出选中按钮点击');
                elements.exportDropdown.classList.add('hidden');
                exportRecords('selected');
            }

            function handleExportAllClick() {
                console.log('导出全部按钮点击');
                elements.exportDropdown.classList.add('hidden');
                exportRecords('all');
            }

            function handleImportBtnClick(e) {
                e.stopPropagation();
                console.log('导入按钮点击');
                elements.importDropdown.classList.toggle('hidden');
            }

            function handleImportSingleClick() {
                console.log('单个导入按钮点击');
                elements.importDropdown.classList.add('hidden');
                elements.importFile.dataset.importType = 'single';
                elements.importFile.click();
            }

            function handleImportBatchClick() {
                console.log('批量导入按钮点击');
                elements.importDropdown.classList.add('hidden');
                elements.importFile.dataset.importType = 'batch';
                elements.importFile.click();
            }

            function handleFileImport(e) {
                console.log('文件导入处理');
                const file = e.target.files[0];
                if (!file) return;
                
                const importType = e.target.dataset.importType;
                processFileImport(file, importType);
                elements.importFile.value = ''; // 重置输入，允许重复选择同一文件
            }

            function handleChangeMonthClick() {
                console.log('切换月份按钮点击');
                elements.monthModal.classList.remove('hidden');
            }

            function handleCloseMonthModalClick() {
                console.log('关闭月份模态框');
                elements.monthModal.classList.add('hidden');
            }

            function handleConfirmMonthClick() {
                console.log('确认月份选择');
                changeMonth();
            }

            function handleCloseDownloadModalClick() {
                console.log('关闭下载模态框');
                elements.downloadModal.classList.add('hidden');
            }

            function handleConfirmDownloadClick() {
                console.log('确认下载');
                confirmDownload();
            }

            function handlePrevPageClick() {
                console.log('上一页点击');
                if (currentPage > 1) {
                    currentPage--;
                    renderRecords();
                }
            }

            function handleNextPageClick() {
                console.log('下一页点击');
                const totalPages = Math.ceil(getFilteredRecords().length / recordsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderRecords();
                }
            }

            function handleSortChange() {
                console.log('排序方式改变');
                currentPage = 1;
                renderRecords();
            }

            function handleFilterChange() {
                console.log('筛选方式改变');
                currentPage = 1;
                renderRecords();
            }

            function handleTableClick(e) {
                // 编辑按钮
                if (e.target.closest('.edit-record')) {
                    const id = e.target.closest('.edit-record').dataset.id;
                    console.log(`编辑记录 ${id}`);
                    openEditRecordModal(id);
                }
                // 删除按钮
                else if (e.target.closest('.delete-record')) {
                    const id = e.target.closest('.delete-record').dataset.id;
                    console.log(`删除记录 ${id}`);
                    deleteRecord(id);
                }
                // 下载单个记录
                else if (e.target.closest('.download-record')) {
                    const id = e.target.closest('.download-record').dataset.id;
                    console.log(`下载记录 ${id}`);
                    exportRecords('single', id);
                }
                // 复选框
                else if (e.target.classList.contains('record-checkbox')) {
                    const id = e.target.dataset.id;
                    console.log(`复选框 ${id} 改变`);
                    if (e.target.checked) {
                        selectedRecordIds.add(id);
                    } else {
                        selectedRecordIds.delete(id);
                    }
                    updateSelectAllCheckbox();
                }
            }

            function handlePageNumberClick(e) {
                if (e.target.tagName === 'BUTTON') {
                    currentPage = parseInt(e.target.textContent);
                    console.log(`切换到页码 ${currentPage}`);
                    renderRecords();
                }
            }

            function handleDocumentClick() {
                elements.exportDropdown.classList.add('hidden');
                elements.importDropdown.classList.add('hidden');
            }

            // 更新记录类型按钮样式
            function updateRecordTypeButtons() {
                if (currentRecordType === 'root') {
                    elements.rootRecordsBtn.classList.add('btn-active');
                    elements.rootRecordsBtn.classList.remove('btn-inactive');
                    elements.monthlyRecordsBtn.classList.add('btn-inactive');
                    elements.monthlyRecordsBtn.classList.remove('btn-active');
                } else {
                    elements.monthlyRecordsBtn.classList.add('btn-active');
                    elements.monthlyRecordsBtn.classList.remove('btn-inactive');
                    elements.rootRecordsBtn.classList.add('btn-inactive');
                    elements.rootRecordsBtn.classList.remove('btn-active');
                }
            }

            // 从本地存储加载数据（替换Firebase，避免网络和配置问题）
            function loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('clanRecords');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        rootRecords = data.root || [];
                        currentRecords = data.monthly && data.monthly[currentMonth] ? data.monthly[currentMonth] : [];
                    }
                } catch (e) {
                    console.error('加载本地数据失败:', e);
                    rootRecords = [];
                    currentRecords = [];
                }
            }

            // 保存数据到本地存储
            function saveToLocalStorage() {
                try {
                    const data = {
                        root: rootRecords,
                        monthly: {
                            ...JSON.parse(localStorage.getItem('clanRecords') || '{"monthly":{}}').monthly,
                            [currentMonth]: currentRecords
                        }
                    };
                    localStorage.setItem('clanRecords', JSON.stringify(data));
                } catch (e) {
                    console.error('保存本地数据失败:', e);
                    showToast('数据保存失败', 'error');
                }
            }

            // 打开编辑记录模态框
            function openEditRecordModal(id) {
                const records = getCurrentRecords();
                const record = records.find(r => r.id === id);
                if (!record) return;

                elements.modalTitle.textContent = '编辑记录';
                elements.recordIdInput.value = record.id;
                elements.prosperityInput.value = record.prosperity || '';
                elements.nameInput.value = record.name || '';
                elements.tagInput.value = record.tag || '';
                elements.positionInput.value = record.position || '';
                elements.maxTrophiesInput.value = record.maxTrophies || '';
                elements.joinDateInput.value = record.joinDate ? record.joinDate.split('T')[0] : '';
                elements.leagueTotalInput.value = record.leagueTotal || '';
                elements.actualTimesInput.value = record.actualTimes || '';
                elements.totalStarsInput.value = record.totalStars || '';
                elements.destructionRateInput.value = record.destructionRate || '';
                elements.scoreInput.value = record.score || '';
                elements.evaluationInput.value = record.evaluation || '';
                
                if (record.inClan !== undefined) {
                    document.querySelector(`input[name="inClan"][value="${record.inClan}"]`).checked = true;
                }
                
                elements.recordModal.classList.remove('hidden');
            }

            // 保存记录
            function saveRecord() {
                const id = elements.recordIdInput.value || generateId();
                const name = elements.nameInput.value.trim();
                
                if (!name) {
                    showToast('请输入名字', 'warning');
                    return;
                }

                const record = {
                    id,
                    prosperity: elements.prosperityInput.value ? parseFloat(elements.prosperityInput.value) : null,
                    name,
                    tag: elements.tagInput.value.trim() || null,
                    position: elements.positionInput.value || null,
                    maxTrophies: elements.maxTrophiesInput.value ? parseInt(elements.maxTrophiesInput.value) : null,
                    joinDate: elements.joinDateInput.value ? new Date(elements.joinDateInput.value).toISOString() : null,
                    leagueTotal: elements.leagueTotalInput.value ? parseInt(elements.leagueTotalInput.value) : null,
                    actualTimes: elements.actualTimesInput.value ? parseInt(elements.actualTimesInput.value) : null,
                    totalStars: elements.totalStarsInput.value ? parseInt(elements.totalStarsInput.value) : null,
                    destructionRate: elements.destructionRateInput.value ? parseFloat(elements.destructionRateInput.value) : null,
                    score: calculateScore(true),
                    evaluation: elements.evaluationInput.value || null,
                    inClan: document.querySelector('input[name="inClan"]:checked').value === 'true',
                    recordMonth: currentMonth,
                    updatedAt: new Date().toISOString()
                };

                const records = getCurrentRecords();
                const index = records.findIndex(r => r.id === id);

                if (index > -1) {
                    records[index] = record; // 编辑
                } else {
                    records.push(record); // 新增
                }

                updateRecords(records);
                saveToLocalStorage();
                elements.recordModal.classList.add('hidden');
                renderRecords();
                updateStatistics();
                showToast(index > -1 ? '记录已更新' : '记录已添加', 'success');
            }

            // 计算得分
            function calculateScore(returnValue = false) {
                const leagueTotal = elements.leagueTotalInput.value ? parseInt(elements.leagueTotalInput.value) : 0;
                const totalStars = elements.totalStarsInput.value ? parseInt(elements.totalStarsInput.value) : 0;
                const position = elements.positionInput.value;
                
                let score = 0;
                
                if (leagueTotal > 0 && totalStars > 0) {
                    score = totalStars / leagueTotal;
                }
                
                if (position === 'leader') score += 2;
                else if (position === 'coLeader') score += 1;
                else if (position === 'elder') score += 0.5;
                
                score = parseFloat(score.toFixed(4));
                elements.scoreInput.value = score > 0 ? score : '';
                
                return returnValue ? score : null;
            }

            // 删除记录
            function deleteRecord(id) {
                if (!confirm('确定要删除这条记录吗？')) return;
                
                const records = getCurrentRecords();
                const updatedRecords = records.filter(r => r.id !== id);
                updateRecords(updatedRecords);
                
                selectedRecordIds.delete(id);
                saveToLocalStorage();
                renderRecords();
                updateStatistics();
                showToast('记录已删除', 'success');
            }

            // 删除选中的记录
            function deleteSelectedRecords() {
                if (selectedRecordIds.size === 0) {
                    showToast('请先选择要删除的记录', 'warning');
                    return;
                }
                
                if (!confirm(`确定要删除选中的 ${selectedRecordIds.size} 条记录吗？`)) return;
                
                const records = getCurrentRecords();
                const updatedRecords = records.filter(r => !selectedRecordIds.has(r.id));
                updateRecords(updatedRecords);
                
                selectedRecordIds.clear();
                saveToLocalStorage();
                renderRecords();
                updateStatistics();
                showToast(`已删除 ${selectedRecordIds.size} 条记录`, 'success');
            }

            // 继承根记录
            function inheritRootRecords() {
                if (rootRecords.length === 0) {
                    showToast('没有根记录可继承', 'warning');
                    return;
                }
                
                if (!confirm(`确定要从根记录继承 ${rootRecords.length} 条记录到当前月份吗？`)) return;
                
                // 复制根记录并生成新ID
                const newRecords = rootRecords.map(record => ({
                    ...record,
                    id: generateId(),
                    recordMonth: currentMonth,
                    updatedAt: new Date().toISOString()
                }));
                
                // 避免重复添加（按名字+标签判断）
                newRecords.forEach(newRecord => {
                    const exists = currentRecords.some(r => 
                        r.name === newRecord.name && r.tag === newRecord.tag
                    );
                    if (!exists) currentRecords.push(newRecord);
                });
                
                saveToLocalStorage();
                renderRecords();
                updateStatistics();
                showToast(`已继承 ${newRecords.length} 条根记录`, 'success');
            }

            // 切换月份
            function changeMonth() {
                const newMonth = elements.selectedMonthInput.value;
                if (!newMonth || newMonth === currentMonth) {
                    elements.monthModal.classList.add('hidden');
                    return;
                }
                
                // 保存当前月份数据
                saveToLocalStorage();
                
                // 切换月份
                currentMonth = newMonth;
                elements.currentMonthDisplay.textContent = formatMonth(currentMonth);
                
                // 加载新月份数据
                const savedData = JSON.parse(localStorage.getItem('clanRecords') || '{"monthly":{}}');
                currentRecords = savedData.monthly && savedData.monthly[currentMonth] ? savedData.monthly[currentMonth] : [];
                
                currentPage = 1;
                renderRecords();
                updateStatistics();
                elements.monthModal.classList.add('hidden');
                showToast(`已切换到 ${formatMonth(currentMonth)}`, 'success');
            }

            // 导出记录
            function exportRecords(type, id = null) {
                const records = getFilteredRecords();
                let recordsToExport = [];
                
                if (type === 'single') {
                    const record = records.find(r => r.id === id);
                    if (record) recordsToExport = [record];
                } else if (type === 'selected') {
                    recordsToExport = records.filter(r => selectedRecordIds.has(r.id));
                    if (recordsToExport.length === 0) {
                        showToast('请先选择要导出的记录', 'warning');
                        return;
                    }
                } else if (type === 'all') {
                    recordsToExport = records;
                    if (recordsToExport.length === 0) {
                        showToast('没有记录可导出', 'warning');
                        return;
                    }
                }
                
                elements.downloadModal.dataset.downloadType = type;
                if (id) elements.downloadModal.dataset.recordId = id;
                elements.downloadModal.classList.remove('hidden');
            }

            // 确认下载
            function confirmDownload() {
                const type = elements.downloadModal.dataset.downloadType;
                const format = document.querySelector('input[name="download-format"]:checked').value;
                const id = elements.downloadModal.dataset.recordId;
                
                const records = getFilteredRecords();
                let recordsToExport = [];
                
                if (type === 'single') {
                    const record = records.find(r => r.id === id);
                    if (record) recordsToExport = [record];
                } else if (type === 'selected') {
                    recordsToExport = records.filter(r => selectedRecordIds.has(r.id));
                } else if (type === 'all') {
                    recordsToExport = records;
                }
                
                exportData(recordsToExport, format);
                elements.downloadModal.classList.add('hidden');
                showToast(`已导出 ${recordsToExport.length} 条记录`, 'success');
            }

            // 处理文件导入
            function processFileImport(file, importType) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let importedRecords;
                        
                        if (file.name.endsWith('.json')) {
                            importedRecords = JSON.parse(content);
                            if (!Array.isArray(importedRecords)) importedRecords = [importedRecords];
                        } else if (file.name.endsWith('.csv')) {
                            importedRecords = parseCSV(content);
                        } else {
                            showToast('仅支持JSON和CSV格式', 'error');
                            return;
                        }
                        
                        importRecords(importedRecords, importType);
                        showToast(`成功导入 ${importedRecords.length} 条记录`, 'success');
                    } catch (error) {
                        console.error('导入失败:', error);
                        showToast('导入失败，请检查文件格式', 'error');
                    }
                };
                
                reader.readAsText(file);
            }

            // 导入记录处理
            function importRecords(importedRecords, importType) {
                const recordsWithIds = importedRecords.map(record => ({
                    ...record,
                    id: record.id || generateId(),
                    recordMonth: currentMonth,
                    updatedAt: new Date().toISOString()
                }));
                
                const targetRecords = getCurrentRecords();
                
                if (importType === 'single') {
                    const record = recordsWithIds[0];
                    const index = targetRecords.findIndex(r => r.id === record.id);
                    if (index > -1) targetRecords[index] = record;
                    else targetRecords.push(record);
                } else {
                    recordsWithIds.forEach(record => {
                        const exists = targetRecords.some(r => r.id === record.id);
                        if (!exists) targetRecords.push(record);
                    });
                }
                
                updateRecords(targetRecords);
                saveToLocalStorage();
                renderRecords();
                updateStatistics();
            }

            // 渲染记录表格
            function renderRecords() {
                const records = getFilteredRecords();
                const sortedRecords = sortRecords([...records]);

                const totalPages = Math.ceil(sortedRecords.length / recordsPerPage);
                const startIndex = (currentPage - 1) * recordsPerPage;
                const paginatedRecords = sortedRecords.slice(startIndex, startIndex + recordsPerPage);
                
                updatePagination(sortedRecords.length, totalPages);
                
                elements.recordsTableBody.innerHTML = '';
                
                if (paginatedRecords.length === 0) {
                    elements.recordsTableBody.innerHTML = `
                        <tr class="text-center">
                            <td colspan="15" class="px-4 py-8 text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                    <p>暂无符合条件的记录</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                paginatedRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    const positionText = getPositionText(record.position);
                    const positionClass = getPositionClass(record.position);
                    const evaluationText = getEvaluationText(record.evaluation);
                    const evaluationClass = getEvaluationClass(record.evaluation);
                    const joinDateText = record.joinDate ? formatDate(record.joinDate) : '';
                    const joinDuration = record.joinDate ? calculateJoinDuration(record.joinDate) : '';
                    const inClanText = record.inClan ? '是' : '否';
                    const inClanClass = record.inClan ? 'text-success' : 'text-gray-500';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="checkbox" class="record-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                   ${selectedRecordIds.has(record.id) ? 'checked' : ''} data-id="${record.id}">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.prosperity || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.name || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.tag || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${positionClass}">${positionText}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.maxTrophies || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div>${joinDateText}</div>
                            <div class="text-xs text-gray-500">${joinDuration}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.leagueTotal || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.actualTimes || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.totalStars || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${record.destructionRate ? record.destructionRate + '%' : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${record.score || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${evaluationClass}">${evaluationText}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap"><span class="${inClanClass}">${inClanText}</span></td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-record text-primary hover:text-primary/80 mr-3" data-id="${record.id}">
                                <i class="fa fa-pencil"></i> 编辑
                            </button>
                            <button class="delete-record text-danger hover:text-danger/80" data-id="${record.id}">
                                <i class="fa fa-trash-o"></i> 删除
                            </button>
                            <button class="download-record text-gray-600 hover:text-gray-800 ml-3" data-id="${record.id}">
                                <i class="fa fa-download"></i>
                            </button>
                        </td>
                    `;
                    
                    elements.recordsTableBody.appendChild(row);
                });
                
                updateSelectAllCheckbox();
            }

            // 更新分页
            function updatePagination(totalRecordsCount, totalPages) {
                if (totalRecordsCount === 0) {
                    elements.pagination.classList.add('hidden');
                    return;
                }
                
                elements.pagination.classList.remove('hidden');
                elements.totalRecords.textContent = totalRecordsCount;
                
                const start = Math.min((currentPage - 1) * recordsPerPage + 1, totalRecordsCount);
                const end = Math.min(currentPage * recordsPerPage, totalRecordsCount);
                elements.currentRange.textContent = `${start}-${end}`;
                
                elements.pageNumbers.innerHTML = '';
                
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                
                if (endPage - startPage < 4 && totalPages >= 5) {
                    if (startPage === 1) endPage = 5;
                    else if (endPage === totalPages) startPage = totalPages - 4;
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium ${i === currentPage ? 'z-10 bg-primary text-white border-primary' : 'text-gray-700 hover:bg-gray-50'}`;
                    pageBtn.textContent = i;
                    elements.pageNumbers.appendChild(pageBtn);
                }
                
                elements.prevPage.disabled = currentPage === 1;
                elements.prevPageMobile.disabled = currentPage === 1;
                elements.nextPage.disabled = currentPage === totalPages;
                elements.nextPageMobile.disabled = currentPage === totalPages;
            }

            // 更新全选框状态
            function updateSelectAllCheckbox() {
                const records = getFilteredRecords();
                const paginatedRecords = records.slice(
                    (currentPage - 1) * recordsPerPage,
                    currentPage * recordsPerPage
                );
                
                elements.selectAllCheckbox.checked = paginatedRecords.length > 0 && 
                                                  paginatedRecords.every(r => selectedRecordIds.has(r.id));
            }

            // 更新统计信息
            function updateStatistics() {
                const records = getCurrentRecords();
                
                elements.totalRecordsCount.textContent = records.length;
                
                const inClan = records.filter(r => r.inClan === true).length;
                elements.inClanCount.textContent = inClan;
                
                const validScores = records
                    .filter(r => r.score !== null && r.score !== undefined)
                    .map(r => parseFloat(r.score));
                
                const avgScore = validScores.length > 0 
                    ? (validScores.reduce((sum, score) => sum + score, 0) / validScores.length).toFixed(4)
                    : '0.0000';
                
                elements.averageScore.textContent = avgScore;
            }

            // 工具函数：获取当前类型的记录
            function getCurrentRecords() {
                return currentRecordType === 'root' ? rootRecords : currentRecords;
            }

            // 工具函数：更新记录
            function updateRecords(records) {
                if (currentRecordType === 'root') {
                    rootRecords = records;
                } else {
                    currentRecords = records;
                }
            }

            // 工具函数：获取筛选后的记录
            function getFilteredRecords() {
                const records = getCurrentRecords();
                const filter = elements.filterSelect.value;
                
                if (filter === 'in-clan') return records.filter(r => r.inClan === true);
                if (filter === 'out-clan') return records.filter(r => r.inClan === false);
                return records;
            }

            // 工具函数：排序记录
            function sortRecords(records) {
                const sortType = elements.sortSelect.value;
                
                switch (sortType) {
                    case 'prosperity': return sortByProsperity(records);
                    case 'score': return sortByScore(records);
                    case 'position': return sortByPosition(records);
                    case 'evaluation': return sortByEvaluation(records);
                    default: return records;
                }
            }

            // 工具函数：按繁荣值排序
            function sortByProsperity(records) {
                return [...records].sort((a, b) => {
                    if (a.prosperity && b.prosperity) return b.prosperity - a.prosperity;
                    if (a.prosperity) return -1;
                    if (b.prosperity) return 1;
                    return 0;
                });
            }

            // 工具函数：按得分排序
            function sortByScore(records) {
                return [...records].sort((a, b) => {
                    if (a.score && b.score) return b.score - a.score;
                    if (a.score) return -1;
                    if (b.score) return 1;
                    return 0;
                });
            }

            // 工具函数：按职位排序
            function sortByPosition(records) {
                const positionPriority = { 'leader': 4, 'coLeader': 3, 'elder': 2, 'member': 1, '': 0 };
                return [...records].sort((a, b) => {
                    return positionPriority[b.position || ''] - positionPriority[a.position || ''];
                });
            }

            // 工具函数：按评测排序
            function sortByEvaluation(records) {
                const evaluationPriority = { 'powerhouse': 4, 'highQuality': 3, 'backbone': 2, 'potential': 1, '': 0 };
                return [...records].sort((a, b) => {
                    return evaluationPriority[b.evaluation || ''] - evaluationPriority[a.evaluation || ''];
                });
            }

            // 工具函数：导出数据
            function exportData(records, format) {
                let data, mimeType, extension;
                
                if (format === 'json') {
                    data = JSON.stringify(records, null, 2);
                    mimeType = 'application/json';
                    extension = 'json';
                } else if (format === 'csv') {
                    data = convertToCSV(records);
                    mimeType = 'text/csv';
                    extension = 'csv';
                }
                
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentRecordType === 'root' ? '根记录' : formatMonth(currentMonth) + '记录'}-${new Date().toISOString().slice(0, 10)}.${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 工具函数：转换为CSV
            function convertToCSV(records) {
                if (records.length === 0) return '';
                
                const headers = [
                    '繁荣', '名字', '标签', '职位', '历史最高奖杯数', 
                    '加入起始时间', '加入累计时间', '当月联赛总次数', 
                    '实际次数', '总星数', '摧毁率(%)', '得分', '评测', '是否在部落'
                ];
                
                const rows = records.map(record => {
                    const joinDuration = record.joinDate ? calculateJoinDuration(record.joinDate) : '';
                    return [
                        record.prosperity || '',
                        record.name || '',
                        record.tag || '',
                        getPositionText(record.position) || '',
                        record.maxTrophies || '',
                        record.joinDate ? formatDate(record.joinDate) : '',
                        joinDuration,
                        record.leagueTotal || '',
                        record.actualTimes || '',
                        record.totalStars || '',
                        record.destructionRate || '',
                        record.score || '',
                        getEvaluationText(record.evaluation) || '',
                        record.inClan ? '是' : '否'
                    ];
                });
                
                return [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                            return `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join(','))
                ].join('\n');
            }

            // 工具函数：解析CSV
            function parseCSV(content) {
                const lines = content.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return [];
                
                // 跳过表头
                lines.shift();
                
                return lines.map(line => {
                    const cells = [];
                    let currentCell = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"' && (i === 0 || line[i-1] !== '"')) {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            cells.push(currentCell.replace(/""/g, '"'));
                            currentCell = '';
                        } else {
                            currentCell += char;
                        }
                    }
                    
                    if (currentCell) {
                        cells.push(currentCell.replace(/""/g, '"').replace(/^"/, '').replace(/"$/, ''));
                    }
                    
                    return {
                        id: generateId(),
                        prosperity: cells[0] ? parseFloat(cells[0]) : null,
                        name: cells[1] || null,
                        tag: cells[2] || null,
                        position: getPositionValue(cells[3]),
                        maxTrophies: cells[4] ? parseInt(cells[4]) : null,
                        joinDate: cells[5] ? new Date(cells[5]).toISOString() : null,
                        leagueTotal: cells[7] ? parseInt(cells[7]) : null,
                        actualTimes: cells[8] ? parseInt(cells[8]) : null,
                        totalStars: cells[9] ? parseInt(cells[9]) : null,
                        destructionRate: cells[10] ? parseFloat(cells[10]) : null,
                        score: cells[11] ? parseFloat(cells[11]) : null,
                        evaluation: getEvaluationValue(cells[12]),
                        inClan: cells[13] === '是',
                        recordMonth: currentMonth,
                        updatedAt: new Date().toISOString()
                    };
                }).filter(record => record.name);
            }

            // 工具函数：生成ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            // 工具函数：格式化日期
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN');
            }

            // 工具函数：格式化月份
            function formatMonth(monthString) {
                const [year, month] = monthString.split('-');
                return `${year}年${parseInt(month)}月`;
            }

            // 工具函数：计算加入时长
            function calculateJoinDuration(joinDateString) {
                const joinDate = new Date(joinDateString);
                const now = new Date();
                
                const diffTime = Math.abs(now - joinDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 30) return `${diffDays} 天`;
                
                const diffMonths = Math.floor(diffDays / 30);
                if (diffMonths < 12) return `${diffMonths} 个月`;
                
                const diffYears = Math.floor(diffMonths / 12);
                const remainingMonths = diffMonths % 12;
                
                return remainingMonths === 0 ? `${diffYears} 年` : `${diffYears} 年 ${remainingMonths} 个月`;
            }

            // 工具函数：职位文本映射
            function getPositionText(position) {
                const map = { 'leader': '首领', 'coLeader': '副首领', 'elder': '长老', 'member': '成员' };
                return map[position] || '';
            }
            function getPositionValue(text) {
                const map = { '首领': 'leader', '副首领': 'coLeader', '长老': 'elder', '成员': 'member' };
                return map[text] || '';
            }
            function getPositionClass(position) {
                const map = {
                    'leader': 'bg-red-100 text-red-800',
                    'coLeader': 'bg-orange-100 text-orange-800',
                    'elder': 'bg-blue-100 text-blue-800',
                    'member': 'bg-gray-100 text-gray-800'
                };
                return map[position] || 'bg-gray-50 text-gray-600';
            }

            // 工具函数：评测文本映射
            function getEvaluationText(evaluation) {
                const map = { 'powerhouse': '实力派', 'highQuality': '优质', 'backbone': '中坚', 'potential': '潜力股' };
                return map[evaluation] || '';
            }
            function getEvaluationValue(text) {
                const map = { '实力派': 'powerhouse', '优质': 'highQuality', '中坚': 'backbone', '潜力股': 'potential' };
                return map[text] || '';
            }
            function getEvaluationClass(evaluation) {
                const map = {
                    'powerhouse': 'bg-purple-100 text-purple-800',
                    'highQuality': 'bg-green-100 text-green-800',
                    'backbone': 'bg-blue-100 text-blue-800',
                    'potential': 'bg-yellow-100 text-yellow-800'
                };
                return map[evaluation] || 'bg-gray-50 text-gray-600';
            }

            // 工具函数：显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastIcon = document.getElementById('toast-icon');
                const toastMessage = document.getElementById('toast-message');

                toastMessage.textContent = message;
                toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center';

                if (type === 'success') {
                    toast.classList.add('bg-success', 'text-white');
                    toastIcon.className = 'fa fa-check-circle mr-2';
                } else if (type === 'error') {
                    toast.classList.add('bg-danger', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-circle mr-2';
                } else if (type === 'warning') {
                    toast.classList.add('bg-warning', 'text-white');
                    toastIcon.className = 'fa fa-exclamation-triangle mr-2';
                } else {
                    toast.classList.add('bg-primary', 'text-white');
                    toastIcon.className = 'fa fa-info-circle mr-2';
                }

                setTimeout(() => {
                    toast.classList.remove('translate-y-20', 'opacity-0');
                }, 10);

                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            // 启动应用
            init();
        }
    </script>
</body>
</html>